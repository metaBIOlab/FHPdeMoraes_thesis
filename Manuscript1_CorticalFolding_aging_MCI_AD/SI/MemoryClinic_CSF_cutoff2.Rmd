---
title: "CSF biomarkers cut-off proposal for Memory Clinic-IDOR subjects"
author: "Fernanda Hansen P. de Moraes"
date: "19/07/2021"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("~/Documentos/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

library(readxl)
# CSF <- read_excel("~/Documentos/Gyrification/data/Medicoes liquor pacientes memory clinic.xlsx", 
#     col_types = c("text", "numeric", "text", 
#         "numeric", "numeric", "numeric", 
#         "numeric", "numeric", "numeric", 
#         "numeric", "skip")) %>%
#   mutate(Diagnostic = factor(Diagnostic))

path <- str_c("~/Documentos/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("~/Documentos/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("~/Documentos/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("~/Documentos/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("~/Documentos/Gyrification/Processamento_longitudinal/V6/data/")

                       # Tabela dos sujeitos

####informacoes dos sujeitos####

tabela_sujeitos <- as_tibble(
  read_delim(
    "~/Documentos/Gyrification/data/tabela_sujeitos.csv",
    ";",
    escape_double = FALSE,
    locale = locale(decimal_mark = ",",
                    grouping_mark = "."),
    trim_ws = TRUE
  )
)

all_sessions <- read_delim(
  str_c(path_sessions, "all_sessions.tsv"),
  "\t",
  escape_double = FALSE,
  trim_ws = TRUE
)

participants <-
  read_delim(
    str_c(path_sessions, "participants.tsv"),
    "\t",
    escape_double = FALSE,
    trim_ws = TRUE
  )

participants <- dplyr::select(participants,-c(group))

part_ses <- full_join(all_sessions, participants)

# cria a coluna subj

part_ses <-
  part_ses %>% mutate(
    SUBJ = str_sub(all_sessions$participant_id, 5, 11),
    Session = str_sub(all_sessions$session_id, 5, 5),
    birthday = as.Date(dob, "%d-%m-%Y"),
    acq_date = as_date(str_sub(all_sessions$acq_time, 1, 10)),
    Age = (acq_date - birthday) / 365
  ) %>% dplyr::select(-c(acq_time))


# RENOMEIA AS VARIAVEIS ----
oldnames = c(
  "Sexo",
  "Data_nascimento",
  "Visita",
  "Idade",
  "Diagnostico",
  "RM  Maquina",
  "Data_aquisicao_RM"
)
newnames <- c("Gender",
              "Birthdate",
              "Session",
              "Age",
              "Diagnostic",
              "machine",
              "acq_date")

tabela_sujeitos <-
  tabela_sujeitos %>% rename_at(vars(oldnames), ~ newnames) %>%
  mutate(SUBJ = SUBJ_clean) %>% 
  dplyr::select(-c(SUBJ_clean)) 

tabela_sujeitos <-
  dplyr::select(tabela_sujeitos,-c(acq_date, Age, NeuroQuant, Lipoxina, Birthdate, machine))
part_ses <-
  dplyr::select(part_ses,-c(participant_id , session_id, dob, sex))

part_ses$Age <- as.numeric(part_ses$Age)
part_ses$Session <- as.numeric(part_ses$Session)

tabela_sujeitos <- full_join(part_ses, tabela_sujeitos) %>% dplyr::select(-c(age))

rm(oldnames)
rm(newnames)

CSF <- read_excel("~/Documentos/Gyrification/data/resultados/alpha_beta.xlsx", sheet = "Sheet1") %>%
  filter(!is.na(TAU),!is.na(`AB1-42`)) %>%
  mutate(Ab42 = `AB1-42`,
         Ab40 = `AB1-40`,
         Total_tau = TAU,
         Ab42_Ab40 = Ab42/Ab40)


CSF <- left_join(CSF,tabela_sujeitos, by=c("SUBJ")) %>%
  mutate(Diagnostic = Diagnostic.x ) %>% 
  dplyr::select(c(SUBJ, Diagnostic, Ab40, Ab42, Total_tau, Ab42_Ab40, birthday, test_date, Gender, acq_date, Age)) %>%
  unique()

# write.csv(CSF, "CSF.csv")

CSF$Diagnostic[CSF$Diagnostic == "a-MCI"] <- "MCI"
CSF$Diagnostic[CSF$Diagnostic == "na-MCI"] <- "MCI"

CSF$Diagnostic <- factor(CSF$Diagnostic)

set.seed(1)
```

# Data description

```{r}
CSF %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    # Age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    TAU = paste(signif(mean(Total_tau, na.rm = TRUE), 2), "±", signif(sd(Total_tau, na.rm = TRUE), 2)),
    Ab42 = paste(signif(mean(Ab42, na.rm = TRUE), 2), "±", signif(sd(Ab42, na.rm = TRUE), 2)),
    Ab40 = paste(signif(mean(Ab40, na.rm = TRUE), 2), "±", signif(sd(Ab40, na.rm = TRUE), 2)),
    Ab42_Ab40 = paste(signif(mean(Ab42_Ab40, na.rm = TRUE), 2), "±", signif(sd(Ab42_Ab40, na.rm = TRUE), 2))) %>%
  kable(digits = 2) %>%
  kable_styling()

CSF %>%
  filter(!is.na(Age)) %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    Age = paste(signif(mean(Age, na.rm = TRUE), 2), "±", signif(sd(Age, na.rm = TRUE), 2)),
    TAU = paste(signif(mean(Total_tau, na.rm = TRUE), 2), "±", signif(sd(Total_tau, na.rm = TRUE), 2)),
    Ab42 = paste(signif(mean(Ab42, na.rm = TRUE), 2), "±", signif(sd(Ab42, na.rm = TRUE), 2)),
    Ab40 = paste(signif(mean(Ab40, na.rm = TRUE), 2), "±", signif(sd(Ab40, na.rm = TRUE), 2)),
    Ab42_Ab40 = paste(signif(mean(Ab42_Ab40, na.rm = TRUE), 2), "±", signif(sd(Ab42_Ab40, na.rm = TRUE), 2))) %>%
  kable(digits = 2) %>%
  kable_styling()
```

```{r}
ggplot(CSF, aes(x = Diagnostic, y = Ab42)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means(method = "anova", label.y = 1500) +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(Ab42 ~ Diagnostic, CSF))
TukeyHSD(aov(Ab42 ~ Diagnostic, CSF))

ggplot(CSF, aes(x = Diagnostic, y = Ab42_Ab40)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means(method = "anova", label.y = 0.65) +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(Ab42_Ab40 ~ Diagnostic, CSF))
TukeyHSD(aov(Ab42_Ab40 ~ Diagnostic, CSF))

ggplot(CSF, aes(x = Diagnostic, y = Total_tau)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means(method = "anova", label.y = 1300) +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(Total_tau ~ Diagnostic, CSF))
TukeyHSD(aov(Total_tau ~ Diagnostic, CSF))

```

# CTL vs AD

Multiple Optimal Cutpoint analysis to infer the methodological differences. 
Positive class: AD;
Negative class: NDC;
Direction: defined automatic for each CSF biomarkers.

## Ab1-42

```{r}
# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
    Ab42,
    Diagnostic,
    pos_class = "AD",
    neg_class = "NDC",
    method = oc_manual,
    cutpoint = 365,
    na.rm = TRUE)
summary(cpAB142)
plot(cpAB142)

cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
    Ab42,
    Diagnostic,
    pos_class = "AD",
    neg_class = "NDC",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpAB142)
plot(cpAB142)


```

## Ab1-42/Ab1-40

```{r}
# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

cpAb42_Ab40 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
    Ab42_Ab40,
    Diagnostic,
    pos_class = "AD",
    neg_class = "NDC",
    method = oc_manual,
    cutpoint = 0.065,
    na.rm = TRUE)
summary(cpAb42_Ab40)
plot(cpAb42_Ab40)

cpAb42_Ab40 <-
    cutpointr(
        filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
        Ab42_Ab40,
        Diagnostic,
        pos_class = "AD",
        neg_class = "NDC",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpAb42_Ab40)
plot(cpAb42_Ab40)


```

## t-Tau

```{r}
# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)


cpTAU <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
    Total_tau,
    Diagnostic,
    pos_class = "AD",
    neg_class = "NDC",
    method = oc_manual,
    cutpoint = 420,
    na.rm = TRUE)
summary(cpTAU)
plot(cpTAU)

cpTAU <-
    cutpointr(
        filter(CSF, Diagnostic == "AD" | Diagnostic == "NDC"),
        Total_tau,
        Diagnostic,
        pos_class = "AD",
        neg_class = "NDC",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpTAU)
plot(cpTAU)

```

## comparing with published cut-offs (Lehmann et al., 2018)

```{r}

ggplot(CSF, aes(x = Diagnostic, y = Ab42)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  geom_hline(aes(yintercept = 420, linetype = "dotted")) +
    geom_hline(aes(yintercept = cpAB142$optimal_cutpoint)) +
  geom_hline(aes(yintercept = 500), linetype = "dashed") +
  guides(alpha = "none") +
  labs(caption= "Dashed line - Lehmann et al.,2108; Solid line - proposed cutpoint, Dotted line = previously defined cutpoint")+
  theme_pubr()

ggplot(CSF, aes(x = Diagnostic, y = Ab42_Ab40)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  geom_hline(aes(yintercept = cpAb42_Ab40$optimal_cutpoint)) +
    geom_hline(aes(yintercept = 0.065, linetype = "dotted")) +
  labs(caption= "Dashed line - Lehmann et al.,2108; Solid line - proposed cutpoint, Dotted line = previously defined cutpoint") +
  geom_hline(aes(yintercept = 0.1), linetype = "dashed") +
  guides(alpha = "none") +
  theme_pubr()

```

# N CTL with A+ or T+

```{r}
CSF <- CSF %>%
  mutate(Ab = ifelse(Ab42 < cpAB142$optimal_cutpoint, str_c("<", signif(cpAB142$optimal_cutpoint,2)), str_c(">", signif(cpAB142$optimal_cutpoint,2))),
        Ab_ratio  = ifelse(Ab42_Ab40 < cpAb42_Ab40$optimal_cutpoint, str_c("<", signif(cpAb42_Ab40$optimal_cutpoint,2)), str_c(">", signif(cpAb42_Ab40$optimal_cutpoint,2))),
         Tau = ifelse(Total_tau > cpTAU$optimal_cutpoint|Total_tau == cpTAU$optimal_cutpoint, str_c(">=", signif(cpTAU$optimal_cutpoint,2)), str_c("<", signif(cpTAU$optimal_cutpoint,2))))

CSF %>%
  group_by(Diagnostic, Ab, Tau) %>%
  summarise(
    N = n_distinct(SUBJ)) %>%
  kable(digits = 2) %>% kable_styling()
```


# CTL vs LBD

Multiple Optimal Cutpoint analysis to infer the methodological differences. 
Positive class: LBD;
Negative class: NDC;
Direction: defined automatic for each CSF biomarkers.

## Ab1-42

```{r eval=FALSE, include=FALSE}
# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
    Ab42,
    Diagnostic,
    pos_class = "LBD",
    neg_class = "NDC",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpAB142)
plot(cpAB142)

```

## Ab1-42/Ab1-40

```{r eval=FALSE, include=FALSE}
# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

# cpAb42_Ab40 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Ab42_Ab40,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpAb42_Ab40)
# plot(cpAb42_Ab40)

cpAb42_Ab40 <-
    cutpointr(
        filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
        Ab42_Ab40,
        Diagnostic,
        pos_class = "LBD",
        neg_class = "NDC",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpAb42_Ab40)
plot(cpAb42_Ab40)

```

```{r eval=FALSE, include=FALSE}
# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
#     Total_tau,
#     Diagnostic,
#     pos_class = "LBD",
#     neg_class = "NDC",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

cpTAU <-
    cutpointr(
        filter(CSF, Diagnostic == "LBD" | Diagnostic == "NDC"),
        Total_tau,
        Diagnostic,
        pos_class = "LBD",
        neg_class = "NDC",
        method = maximize_boot_metric,
        metric = sum_sens_spec,
        na.rm = TRUE,
        boot_runs = 1000,
    use_midpoints = TRUE)
summary(cpTAU)
plot(cpTAU)


```