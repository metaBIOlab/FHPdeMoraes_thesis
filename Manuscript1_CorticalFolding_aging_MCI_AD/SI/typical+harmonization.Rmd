---
title: "Typical"
author: "Fernanda Hansen P. de Moraes"
date: "05/03/2021"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("C:/Users/ferna/Documents/idor/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

# onde estao os arquivos de resultados:
path <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("C:/Users/ferna/Documents/idor/Gyrification/Processamento_longitudinal/V6/data/")

Age.cor = 25

# Prepara os dados para analise
source("05-analises_prep.R")

dados_datasetscomp <- dados_datasetscomp %>% filter(Sample != "HCP500r")

# dados_datasetscomp <- dados_datasetscomp %>% filter(Age == 18 | Age > 18)

# write.csv(dados_datasetscomp,"dados_datasetscomp.csv")
```

# Datasets description

We included multiple datasets from different sites to estimate, accounting methodological and "subject" biases, typical values for K, S and I.

```{r description, echo=FALSE}
filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp,
       Sample != "Mota&Houzel2015",
       ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT =  paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    AT =  paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    AE =  paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K =  paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S =  paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I =  paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  ) %>% kable(digits = 2) %>% kable_styling()


filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic, Gender) %>%
  summarise(
    N = n_distinct(SUBJ)
) %>% kable(digits = 2) %>% kable_styling()
```

# Mapping

## CTL

```{r}
amostra_Coef <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval) %>%
    do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "logExposedArea")

amostra_Coef$Age_intervalnumber <- as.numeric(factor(amostra_Coef$Age_interval))-1

cor.test(amostra_Coef$estimate, amostra_Coef$Age_intervalnumber)

cor.test(filter(amostra_Coef, Age_intervalnumber > 1)$estimate, filter(amostra_Coef, Age_intervalnumber > 1)$Age_intervalnumber)

ggplot(amostra_Coef, aes(y = estimate, x = Age_interval)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="Slope", x = "Age interval") +  geom_text(aes(label = N), nudge_y = 0.3)

amostra_Coef %>% dplyr::select(-c(term)) %>% kable() %>% kable_styling()

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100"), aes(y = K, x = Age_interval), aes(y = K, x = Age_interval)) +
    geom_boxplot() + 
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) 
```

```{r}
amostra_Coef <- filter(dados_datasetscomp, ROI != "hemisphere",Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(ROI, Age_interval) %>%
    do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp, ROI != "hemisphere",Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(ROI, Age_interval) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "logExposedArea")

ggplot(amostra_Coef, aes(y = estimate, x = Age_interval)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + facet_wrap(ROI ~ .)

ggplot(filter(dados_datasetscomp, ROI != "hemisphere",Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100"), aes(y = K, x = Age_interval), aes(y = K, x = Age_interval)) +
    geom_boxplot() + 
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    )  + facet_wrap(ROI ~ .)

```

```{r}
amostra_Coef <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "AD", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval, Diagnostic) %>%
    do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "AD", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval, Diagnostic) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "logExposedArea")

amostra_Coef$Diagnostic <- factor(amostra_Coef$Diagnostic, levels=c('AD', 'CTL'))

ggplot(amostra_Coef, aes(y = estimate, x = Age_interval, color = Diagnostic)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="Slope", x = "Age interval") +  geom_text(aes(label = N), nudge_y = 0.3)

amostra_Coef %>% dplyr::select(-c(term)) %>% kable() %>% kable_styling()

```

```{r mapping}
paste("Total number of CTL subjects =", n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$SUBJ))
paste("Age range CTL. Min age = ", min(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age), "; max age = ", max(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age))

figS6a <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age , y = K)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = (Age*12*4)+40 , y = K)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") + geom_vline(xintercept = 40, linetype = "dashed") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [weeks] (age of birth defined as 40 weeks)") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10)) + xlim(0,1000)

#figS6a

figS6b <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = S)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

#figS6b

figS6c <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = I)) + geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) + 
  geom_smooth(color = "black", method = "lm") + theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")
 
# figS6c      

figS6 <- ggarrange(figS6a, ggarrange(figS6b, figS6c,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

figS6

ggsave("figS6.pdf", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "pdf")
ggsave("figS6.png", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$K, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$S, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$I, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)
```

# Decreasing rate

```{r}
dados_datasetscomp_rate <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")
dados_datasetscomp_rate$Diagnostic <- factor(dados_datasetscomp_rate$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate$Sample <- as.factor(dados_datasetscomp_rate$Sample)

N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))
```

## AvgThickness \~ Age

```{r}
m.1 <- lme4::lmer(AvgThickness ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

#performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableT <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgT/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "Avg Cortical Thickness", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="T variation", x = "Sample")

re <- filter(re, grpvar == "Sample") %>% mutate(T_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(AvgThickness_shiftc = AvgThickness - T_shift)
```

## TotalArea \~ Age

```{r}
m.1 <- lme4::lmer(TotalArea ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableAT <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "AT")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AT/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "AT", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample") %>% mutate(AT_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(TotalArea_shiftc = TotalArea - AT_shift)
```

## ExposedArea \~ Age

```{r}
m.1 <- lme4::lmer(ExposedArea ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableAE <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "AE")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AE/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "AE", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))
re <- filter(re, grpvar == "Sample") %>% mutate(AE_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(ExposedArea_shiftc = ExposedArea - AE_shift)
```

## GI \~ Age

```{r}
m.1 <- lme4::lmer(localGI ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableGI <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "GI")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "GI", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))
re <- filter(re, grpvar == "Sample") %>% mutate(GI_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(localGI_shiftc = localGI - GI_shift)
```

```{r}
GI_shifta <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = localGI, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + labs(y = "GI")

GI_shiftb <- ggplot(filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = localGI_shiftc, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + labs(y = "GI (shift removed)")


GI_shift <- ggarrange(GI_shifta, GI_shiftb,labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
GI_shift
ggsave("GI_shift.png", plot = GI_shift, width = 18, height = 22, units = "cm", device = "png")
```

## K \~ Age

```{r}
N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))

m.1 <- lme4::lmer(K ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableK <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ) 
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_K_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))
# write.csv(re, "reK.csv")

sampleeff.K <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="K variation", x = "Sample")

eK <- e

re <- filter(re, grpvar == "Sample") %>% mutate(K_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(K_shiftc = K - K_shift)
```

```{r}
K_shifta <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = K, color = Sample, alpha = 0.4))+
  geom_point() +
  theme_pubr() + 
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

K_shiftb <- ggplot(filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = K_shiftc, color = Sample, alpha = 0.4))+
  geom_point() +
    guides(alpha = FALSE) + 
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + labs(y = "K (shift removed)")


K_shift <- ggarrange(K_shifta, K_shiftb,labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
K_shift
ggsave("K_shift.png", plot = K_shift, width = 18, height = 22, units = "cm", device = "png")
```

## S \~ Age

```{r}
m.1 <- lme4::lmer(S ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableS <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_S_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_S_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

re <- as_tibble(ranef(m.1)) 
# write.csv(re, "reS.csv")
        
sampleeff.S <- ggplot( filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "S variation", x = "Sample")

eS <- e

re <- filter(re, grpvar == "Sample") %>% mutate(S_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re, by=c("Sample")) %>%
  mutate(S_shiftc = S - S_shift)
```

```{r}
S_shifta <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = S, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

S_shiftb <- ggplot(filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = S_shiftc, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + labs(y = "S (shift removed)")


S_shift <- ggarrange(S_shifta, S_shiftb,labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
S_shift
ggsave("S_shift.png", plot = S_shift, width = 18, height = 22, units = "cm", device = "png")
```

## I \~ Age

```{r}
m.1 <- lme4::lmer(I ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableI <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_I_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_I_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

re <- as_tibble(ranef(m.1))
# write.csv(re, "reI.csv")

sampleeff.I <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "I variation", x = "Sample")

eI <- e

re <- filter(re, grpvar == "Sample") %>% mutate(I_shift = condval, Sample = grp) %>% dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate <- full_join(dados_datasetscomp_rate, re) %>% mutate(I_shiftc = I - I_shift)
```

```{r}
I_shifta <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = I, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

I_shiftb <- ggplot(filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = I_shiftc, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + labs(y = "I (shift removed)")


I_shift <- ggarrange(I_shifta, I_shiftb,labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
I_shift
ggsave("I_shift.png", plot = I_shift, width = 18, height = 22, units = "cm", device = "png")
```

## Figures

```{r eval=FALSE, include=FALSE}
eK <- eK %>%
  mutate(K = fit, K.se = se, Knorm = K/sqrt(1 + (1/4)^2 + (5/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, K, K.se, Knorm))
eS <- eS %>%
  mutate(S = fit, S.se = se, Snorm = S/sqrt((3/2)^2 + (3/4)^2 + (9/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, S, S.se, Snorm))
eI <- eI %>%
  mutate(I = fit, I.se = se, Inorm = I/sqrt(1^2 + 1^2 + 1^2)) %>%
  dplyr::select(c(Age, Diagnostic, I, I.se, Inorm))

e <- full_join(eK, eS) %>%
  full_join(eI) %>% as_tibble()

plot_ly(
e,
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))

plot_ly(
filter(e, Diagnostic == "AD" |Diagnostic == "CTL", Age == "50" | Age == "100"),
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))
```

```{r}
fig_TX_age <- ggarrange(fig_TX_K_age, ggarrange(fig_TX_S_age, fig_TX_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age

fig_age <- ggarrange(fig_K_age, ggarrange(fig_S_age, fig_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_age

fig_sampleeff <- ggarrange(sampleeff.K, ggarrange(sampleeff.S, sampleeff.I,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_sampleeff

ggsave("fig_TX_age.pdf", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age.png", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

ggsave("fig_age.pdf", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_age.png", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

ggsave("fig_sampleeff.png", plot = fig_sampleeff, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, percent, Variable))
tableK <- tableK %>% dplyr::select(c(Diagnostic, percent, Variable))
tableS <- tableS %>% dplyr::select(c(Diagnostic, percent, Variable))
tableI <- tableI %>% dplyr::select(c(Diagnostic, percent, Variable))
tableGI <- tableGI %>% dplyr::select(c(Diagnostic, percent, Variable))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI)  %>% full_join(tableGI)

rate %>% kable() %>% kable_styling()

```

## Comparing methods

We estimate the coefficients and uncertainties with two methods: (a) linear regression and (b) Bayesian modeling. From (a) we calculated the linear regression model error, based on the coefficients errors, and the fluctuation around a certain value of age, with the Residual Standard Error; (b) estimated the fluctuation around a certain value of age.

```{r}
cbPalette <- c("#000000", "#FF0000")

coefsK <- read_excel("coefs.xlsx", sheet = "K")

figcoefsK <- ggplot(coefsK, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="K systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefsS <- read_excel("coefs.xlsx", sheet = "S")

figcoefsS <- ggplot(coefsS, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="S systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefsI <- read_excel("coefs.xlsx", sheet = "I")

figcoefsI <- ggplot(coefsI, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="I systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefs <- ggarrange(figcoefsK, ggarrange(figcoefsS, figcoefsI,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ggsave("coefs.png", plot = coefs, width = 18, height = 22, units = "cm", device = "png")
```

# After harmonization

```{r}
amostra_Coef <- filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval) %>%
    do(fit_amostra = tidy(lm(1/2 * log10(AvgThickness_shiftc) + log10(TotalArea_shiftc) ~ log10(ExposedArea_shiftc), data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "log10(ExposedArea_shiftc)")

amostra_Coef$Age_intervalnumber <- as.numeric(factor(amostra_Coef$Age_interval))-1

cor.test(amostra_Coef$estimate, amostra_Coef$Age_intervalnumber)

cor.test(filter(amostra_Coef, Age_intervalnumber > 1)$estimate, filter(amostra_Coef, Age_intervalnumber > 1)$Age_intervalnumber)

fig_slope_ageinterval <- ggplot(amostra_Coef, aes(y = estimate, x = Age_interval)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() +
  geom_line(group = 1) + 
  geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="Slope (after harmonization)", x = "Age interval") +  geom_text(aes(label = N), nudge_y = 0.3)

fig_slope_ageinterval

ggplot(filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100"), aes(y = K_shiftc, x = Age_interval), aes(y = K, x = Age_interval)) +
    geom_boxplot() + 
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="K (after harmonization)", x = "Age interval")

ggsave("fig_slope_ageinterval.png", plot = fig_slope_ageinterval, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
ggsave("fig_slope_ageinterval.eps", plot = fig_slope_ageinterval, dpi=1200, width = 18, height = 18, units = "cm", device = "eps")
```


```{r}
amostra_Coef <- filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "AD" , Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval, Diagnostic) %>%
    do(fit_amostra = tidy(lm(1/2 * log10(AvgThickness_shiftc) + log10(TotalArea_shiftc) ~ log10(ExposedArea_shiftc), data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp_rate, ROI == "hemisphere", Diagnostic == "CTL"| Diagnostic == "AD" , Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval, Diagnostic) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "log10(ExposedArea_shiftc)")

amostra_Coef$Diagnostic <- factor(amostra_Coef$Diagnostic, levels=c('AD', 'CTL'))

ggplot(amostra_Coef, aes(y = estimate, x = Age_interval, color = Diagnostic)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="Slope (after harmonization)", x = "Age interval") +  geom_text(aes(label = N), nudge_y = 0.3)

amostra_Coef%>% dplyr::select(-c(term)) %>% kable() %>% kable_styling()

```

## AvgThickness \~ Age

```{r}
m.1 <- lme4::lmer(AvgThickness_shiftc ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableT <- full_join(mean, lst, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgT/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "Avg Cortical Thickness", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="T variation", x = "Sample")

```

## GI \~ Age

```{r}
m.1 <- lme4::lmer(localGI_shiftc ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableGI <- full_join(mean, lst, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "localGI_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "GI", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="T variation", x = "Sample")

```

## K \~ Age

```{r}
m.1 <- lme4::lmer(K_shiftc ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableK <- full_join(mean, lst, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ) 
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age_c <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_K_age_c <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))
write.csv(re, "reK_c.csv")

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="K variation", x = "Sample")

eK <- e

```

## S \~ Age

```{r}
m.1 <- lme4::lmer(S_shiftc ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableS <- full_join(mean, lst, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_S_age_c <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_S_age_c <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

re <- as_tibble(ranef(m.1)) 
write.csv(re, "reS_c.csv")

ggplot( filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "S variation", x = "Sample")

eS <- e

```


## I \~ Age

```{r}
m.1 <- lme4::lmer(I_shiftc ~ Age * Diagnostic + (1|Sample) + (1|Sample:Diagnostic) , data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableI <- full_join(mean, lst, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_I_age_c <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_I_age_c <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

re <- as_tibble(ranef(m.1))
write.csv(re, "reI_c.csv")

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "I variation", x = "Sample")

eI <- e
```

## Figures

```{r eval=FALSE, include=FALSE}
eK <- eK %>%
  mutate(K = fit, K.se = se, Knorm = K/sqrt(1 + (1/4)^2 + (5/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, K, K.se, Knorm))
eS <- eS %>%
  mutate(S = fit, S.se = se, Snorm = S/sqrt((3/2)^2 + (3/4)^2 + (9/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, S, S.se, Snorm))
eI <- eI %>%
  mutate(I = fit, I.se = se, Inorm = I/sqrt(1^2 + 1^2 + 1^2)) %>%
  dplyr::select(c(Age, Diagnostic, I, I.se, Inorm))

e <- full_join(eK, eS) %>%
  full_join(eI) %>% as_tibble()

plot_ly(
e,
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))

plot_ly(
filter(e, Diagnostic == "AD" |Diagnostic == "CTL", Age == "50" | Age == "100"),
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))
```

```{r}
fig_TX_age_c <- ggarrange(fig_TX_K_age_c, ggarrange(fig_TX_S_age_c, fig_TX_I_age_c,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_c

fig_age_c <- ggarrange(fig_K_age_c, ggarrange(fig_S_age_c, fig_I_age_c,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_age_c

ggsave("fig_TX_age_c.pdf", plot = fig_TX_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age_c.png", plot = fig_TX_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
ggsave("fig_TX_age_c.eps", plot = fig_TX_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "eps")

ggsave("fig_age_c.pdf", plot = fig_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_age_c.png", plot = fig_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
ggsave("fig_age_c.eps", plot = fig_age_c, dpi=1200, width = 18, height = 18, units = "cm", device = "eps")
```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, percent, Variable, Age.trend, SE.y))
tableK <- tableK %>% dplyr::select(c(Diagnostic, percent, Variable, Age.trend, SE.y))
tableS <- tableS %>% dplyr::select(c(Diagnostic, percent, Variable, Age.trend, SE.y))
tableI <- tableI %>% dplyr::select(c(Diagnostic, percent, Variable, Age.trend, SE.y))
tableGI <- tableGI %>% dplyr::select(c(Diagnostic, percent, Variable, Age.trend, SE.y))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI) %>% full_join(tableGI)

rate %>% mutate(TX = paste(signif(Age.trend, 2), "±", signif(SE.y, 2)), percent = signif(percent, 2))

# rate %>% kable() %>% kable_styling()

```

# LOBES

```{r echo=FALSE}
dados_datasetscomp_rate_lobes <- filter(dados_datasetscomp, ROI != "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")
dados_datasetscomp_rate_lobes$Diagnostic <- factor(dados_datasetscomp_rate_lobes$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate_lobes$Sample <- as.factor(dados_datasetscomp_rate_lobes$Sample)

N_SUBJ <- dados_datasetscomp_rate_lobes %>% group_by(Diagnostic, ROI) %>% summarise(N_SUBJ = n_distinct(SUBJ))
```

### AvgThickness \~ Age

```{r}
ggplot(dados_datasetscomp_rate_lobes, aes(x = Age, y = AvgThickness, color = Sample)) + 
  geom_point() + 
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9)) + 
  facet_grid(ROI ~.)
```

```{r}
ggplot(dados_datasetscomp_rate_lobes, aes(x = Age, y = K, color = Sample)) + 
  geom_point() + 
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9)) + 
  facet_grid(ROI ~.)
```

```{r echo=FALSE}
m.1 <- lme4::lmer(AvgThickness ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableT <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "AvgThickness", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample:ROI"), aes(y = condval, x = as.character(grp))) +
   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
   theme_pubr() + 
   theme(axis.title = element_text(size = 11),
     axis.text = element_text(size = 10),
     text = element_text(size = 10),
     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
   ) +
  labs(y ="T variation", x = "Sample")

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), T_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(AvgThickness_shiftc = AvgThickness - T_shift)
```

### TotalArea \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(TotalArea ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), AT_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(TotalArea_shiftc = TotalArea - AT_shift)
```

### ExposedArea \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(ExposedArea ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), AE_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(ExposedArea_shiftc = ExposedArea - AE_shift)
```


### GI \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(localGI ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableT <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "GI")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "GI", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample:ROI"), aes(y = condval, x = as.character(grp))) +
   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
   theme_pubr() + 
   theme(axis.title = element_text(size = 11),
     axis.text = element_text(size = 10),
     text = element_text(size = 10),
     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
   ) +
  labs(y ="GI variation", x = "Sample")

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), GI_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(GI_shiftc = localGI - GI_shift)
```

### K \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(K ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableK <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

TX_K_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_K_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_K_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), K_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1], SD_K_shift = condsd) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

ggplot(re, aes(y = K_shift, x = Sample)) +
  geom_point() +
  geom_errorbar(aes(ymin = K_shift+1.96*SD_K_shift, ymax = K_shift-1.96*SD_K_shift), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="K variation", x = "Sample") +
  facet_grid(ROI ~. )

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(K_shiftc = K - K_shift)
```

```{r}
K_shiftc <- ggplot(filter(dados_datasetscomp_rate_lobes, ROI != "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = K, color = Sample, alpha = 0.4))+
  geom_point() +
  theme_pubr() + 
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + facet_grid(ROI ~. )

K_shiftd <- ggplot(filter(dados_datasetscomp_rate_lobes, ROI != "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = K_shiftc, color = Sample, alpha = 0.4))+
  geom_point() +
    guides(alpha = FALSE) + 
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  labs(y = "K (shift removed)") +
  facet_grid(ROI ~. )


K_shift_lobes <- ggarrange(K_shiftc, K_shiftd ,labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")
K_shift_lobes
ggsave("K_shift_lobes.png", plot = K_shift_lobes, width = 18, height = 22, units = "cm", device = "png")
ggsave("K_shift_lobes.eps", plot = K_shift_lobes, width = 18, height = 22, units = "cm", device = "eps")
```

### S \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(S ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableS <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_S_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_S_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_S_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), S_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(S_shiftc = S - S_shift)
```

### I \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(I ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableI <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_I_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_I_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_I_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

re <- as_tibble(ranef(m.1))

re <- filter(re, grpvar == "Sample:ROI") %>%
  mutate(ROI = str_sub(grp, -1, 20), I_shift = condval, Sample = str_split(grp, pattern = ":", simplify = TRUE)[,1]) %>%
  dplyr::select(-c(condval, grpvar, term, condsd, grp))

dados_datasetscomp_rate_lobes <- full_join(dados_datasetscomp_rate_lobes, re) %>% mutate(I_shiftc = I - I_shift)
```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableK <- tableK %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableS <- tableS %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableI <- tableI %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI) %>% mutate(percent = signif(percent, 2), TX = paste(signif(Age.trend, 2), "±", signif(SE.y, 2)))
rate
```
## After harmonization
```{r}
ggplot(dados_datasetscomp_rate_lobes, aes(x = Age, y = AvgThickness_shiftc, color = Sample)) + 
  geom_point() + 
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9)) + 
  facet_grid(ROI ~.)
```

```{r}
ggplot(dados_datasetscomp_rate_lobes, aes(x = Age, y = K_shiftc, color = Sample)) + 
  geom_point() + 
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9)) + 
  facet_grid(ROI ~.)
```

```{r}
amostra_Coef <- filter(dados_datasetscomp_rate_lobes, ROI != "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(ROI, Age_interval) %>%
    do(fit_amostra = tidy(lm(1/2 * log10(AvgThickness_shiftc) + log10(TotalArea_shiftc) ~ log10(ExposedArea_shiftc), data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
    unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp_rate_lobes, ROI != "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100") %>%
    group_by(Age_interval) %>%
    summarise(
        N = n_distinct(SUBJ),
        min_age = min(Age),
        max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "log10(ExposedArea_shiftc)")

amostra_Coef$Age_intervalnumber <- as.numeric(factor(amostra_Coef$Age_interval))-1

cor.test(filter(amostra_Coef, ROI == "F")$estimate, filter(amostra_Coef, ROI == "F")$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "O")$estimate, filter(amostra_Coef, ROI == "O")$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "P")$estimate, filter(amostra_Coef, ROI == "P")$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "T")$estimate, filter(amostra_Coef, ROI == "T")$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "F", Age_intervalnumber > 1)$estimate, filter(amostra_Coef, ROI == "F", Age_intervalnumber > 1)$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "O", Age_intervalnumber > 1)$estimate, filter(amostra_Coef, ROI == "O", Age_intervalnumber > 1)$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "P", Age_intervalnumber > 1)$estimate, filter(amostra_Coef, ROI == "P", Age_intervalnumber > 1)$Age_intervalnumber)

cor.test(filter(amostra_Coef, ROI == "T", Age_intervalnumber > 1)$estimate, filter(amostra_Coef, ROI == "T", Age_intervalnumber > 1)$Age_intervalnumber)

fig_slope_lobes_ageinterval <- ggplot(amostra_Coef, aes(y = estimate, x = Age_interval)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    geom_point() +
  geom_line(group = 1) + 
  geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="Slope (after harmonization)", x = "Age interval")  + facet_wrap(ROI ~. )

fig_slope_lobes_ageinterval

ggplot(filter(dados_datasetscomp_rate_lobes, ROI != "hemisphere", Diagnostic == "CTL", Age_interval != "00-05", Age_interval != "95-100"), aes(y = K_shiftc, x = Age_interval), aes(y = K, x = Age_interval)) +
    geom_boxplot() + 
    theme_pubr() + 
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10),
          text = element_text(size = 10),
          axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    ) + labs(y ="K (after harmonization)", x = "Age interval") + facet_wrap(ROI ~. )

ggsave("fig_slope_lobes_ageinterval.png", plot = fig_slope_lobes_ageinterval, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
ggsave("fig_slope_lobes_ageinterval.eps", plot = fig_slope_lobes_ageinterval, dpi=1200, width = 18, height = 18, units = "cm", device = "eps")
```

### AvgThickness \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(AvgThickness_shiftc ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic)  + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableT <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "AvgThickness", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

```


### GI \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(GI_shiftc ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic)  + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableGI <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "GI_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "GI", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

```

### K \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(K_shiftc ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableK <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

TX_K_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))
TX_K_Within_regions

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_K_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
fit_K_lobes

```

### S \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(S_shiftc ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableS <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_S_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))
TX_S_Within_regions

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_S_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
fit_S_lobes

```

### I \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(I_shiftc ~ Age * Diagnostic * ROI + (1|Sample) + (1|Sample:Diagnostic) + (1|Sample:ROI), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

lst <- m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)))

tableI <- full_join(mean, lst, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I_shiftc")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_I_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))
TX_I_Within_regions

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_I_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
fit_I_lobes

```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableK <- tableK %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableS <- tableS %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableI <- tableI %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableGI <- tableGI %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI) %>% full_join(tableGI)

rate <- rate %>% mutate(TX = paste(signif(Age.trend, 2), "±", signif(SE.y, 2)), percent = signif(percent, 2)) %>% dplyr::select(-c(Age.trend, SE.y))
rate
# write.csv(rate, "rate_lobes_c.csv")
```

## Figures

```{r echo=FALSE}

fig_TX_age_lobes_ROI <- ggarrange(TX_K_Within_regions, TX_S_Within_regions, TX_I_Within_regions,labels = c("A","B","C"), nrow = 3, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_lobes_DIAG <- ggarrange(TX_K_Within_DIAG, TX_S_Within_DIAG, TX_I_Within_DIAG,labels = c("A","B","C"), nrow = 3, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_lobes_ROI
fig_TX_age_lobes_DIAG

ggsave("fig_TX_age_c.pdf", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")

ggsave("fig_TX_age_lobes_ROI_c.png", plot = fig_TX_age_lobes_ROI, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

ggsave("fig_age_c.pdf", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")

ggsave("fig_TX_age_lobes_DIAG_c.png", plot = fig_TX_age_lobes_DIAG, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

ggsave("fig_sampleeff_c.png", plot = fig_sampleeff, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

ggsave("fig_TX_age_lobes_ROI_c.eps", plot = fig_TX_age_lobes_ROI, dpi=1200, width = 18, height = 22, units = "cm", device = "eps")

ggsave("fig_TX_age_lobes_DIAG_c.eps", plot = fig_TX_age_lobes_DIAG, dpi=1200, width = 18, height = 22, units = "cm", device = "eps")

ggsave("fig_sampleeff_c.eps", plot = fig_sampleeff, dpi=1200, width = 18, height = 18, units = "cm", device = "eps")

fit_lobes <- ggarrange(fit_K_lobes, ggarrange(fit_S_lobes, fit_I_lobes,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fit_S_lobes

ggsave("fit_lobes_c.png", plot = fit_lobes, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

ggsave("fit_K_lobes_c.png", plot = fit_K_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")

ggsave("fit_S_lobes_c.png", plot = fit_S_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")

ggsave("fit_I_lobes_c.png", plot = fit_I_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")

ggsave("fit_lobes_c.eps", plot = fit_lobes, dpi=1200, width = 18, height = 22, units = "cm", device = "eps")

ggsave("fit_K_lobes_c.eps", plot = fit_K_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "eps")

ggsave("fit_S_lobes_c.eps", plot = fit_S_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "eps")

ggsave("fit_I_lobes_c.eps", plot = fit_I_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "eps")
```
