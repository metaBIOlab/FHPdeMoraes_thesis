---
title: "Typical"
author: "Fernanda Hansen P. de Moraes"
date: "05/03/2021"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("C:/Users/ferna/Documents/idor/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

# onde estao os arquivos de resultados:
path <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("C:/Users/ferna/Documents/idor/Gyrification/Processamento_longitudinal/V6/data/")

Age.cor = 25

# Prepara os dados para analise
source("05-analises_prep.R")

dados_datasetscomp <- dados_datasetscomp %>% filter(Sample != "HCP500r")

# dados_datasetscomp <- dados_datasetscomp %>% filter(Age == 18 | Age > 18)

# write.csv(dados_datasetscomp,"dados_datasetscomp.csv")
```

# Datasets description

We included multiple datasets from different sites to estimate, accounting methodological and "subject" biases, typical values for K, S and I.

```{r description, eval=FALSE, include=FALSE}
filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp,
       Sample != "Mota&Houzel2015",
       ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT =  paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    AT =  paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    AE =  paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K =  paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S =  paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I =  paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  ) %>% kable(digits = 2) %>% kable_styling()


filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic, Gender) %>%
  summarise(
    N = n_distinct(SUBJ)
) %>% kable(digits = 2) %>% kable_styling()
```

```{r}
# source("harmonization.R")

dados_datasetscomp$ROI <- factor(dados_datasetscomp$ROI, levels = c("hemisphere", "F", "O", "P", "T"))
```

# Results
```{r echo=FALSE}
ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(x = Age, y = K, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

dados_datasetscomp_AOMIC <- filter(dados_datasetscomp, Sample == "AOMICPIOP1" | Sample == "AOMICPIOP2")

```

## Dados AOMICPIO1 e PIO2 min Age = 18 e max Age = 26.

```{r eval=FALSE, include=FALSE}
ggplot(filter(dados_datasetscomp_AOMIC, ROI == "hemisphere"), aes(x = Age, y = K, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K ~ Age+I(Age^2), data = filter(dados_datasetscomp_AOMIC, ROI == "hemisphere"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))

```

## Age < 25.

```{r eval=FALSE, include=FALSE}
ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Age < 25), aes(x = Age, y = K, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "hemisphere", Age < 25))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

## Age < 25, filter out AHEAD and HCPr900.

```{r eval=FALSE, include=FALSE}
ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "hemisphere", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))

```

# After harmonization
## Dados AOMICPIO1 e PIO2 min Age = 18 e max Age = 26.

```{r echo=FALSE}
ggplot(filter(dados_datasetscomp_AOMIC, ROI == "hemisphere", Age < 25), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp_AOMIC, ROI == "hemisphere"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))

```

## Age < 25.

```{r echo=TRUE}
ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Age < 25), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "hemisphere", Age < 25))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

## Age < 25, filter out AHEAD and HCPr900.

```{r echo=TRUE}
ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "hemisphere", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))

```

# Lobes - Age < 25, filter out AHEAD and HCPr900

## Frontal 

```{r}
ggplot(filter(dados_datasetscomp, ROI == "F", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "F", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

## Occipital 

```{r}
ggplot(filter(dados_datasetscomp, ROI == "O", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "O", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

## Parietal 

```{r}
ggplot(filter(dados_datasetscomp, ROI == "P", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "P", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

## Temporal 

```{r}
ggplot(filter(dados_datasetscomp, ROI == "T", Age < 25, Sample != "AHEAD", Sample != "HCPr900"), aes(x = Age, y = K_shiftc, color = Sample))+
  geom_point() +
  geom_smooth(method = "lm", col = "gray") +
  stat_smooth(method = "lm", formula=y ~ x+I(x^2), col = "red") +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

f <- lm(K_shiftc ~ Age+I(Age^2), data = filter(dados_datasetscomp, ROI == "T", Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(f)
s <- summary(f)

a = as.double(f$coefficients[3])
b = as.double(f$coefficients[2])
c = as.double(f$coefficients[1])
sigma.a = s$coefficients[3,2]
sigma.b = s$coefficients[2,2]

# deriv(~a*x^2+b*x+c, "x")

age = -b/(2*a)

sigma.age = sqrt((1/2*a)^2*sigma.b^2+(-b/(2*a)^2)^2*(2*sigma.a)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))
```

# Teste lobos 
```{r eval=FALSE, include=FALSE}
l <- lm(K_shiftc ~ Age*ROI+I(Age^2)*ROI, data = filter(dados_datasetscomp, Age < 25, Sample != "AHEAD", Sample != "HCPr900"))
summary(l)
s <- summary(l)

bs <- as_tibble(lsmeans(l, ~ ROI, var="Age"))
pairs(lsmeans(l, ~ ROI, var="Age"))

as <- as_tibble(lstrends(l, ~ ROI, var="Age"))
pairs(lstrends(l, ~ ROI, var="Age"))

age = -bs$lsmean/(2*as$Age.trend)

sigma.age = sqrt((1/2*as$Age.trend)^2*bs$SE^2+(-bs$lsmean/(2*as$Age.trend)^2)^2*(2*as$SE)^2)

paste("f' = 0 at: ",signif(age,2), " ± ", signif(sigma.age,2))

```

