---
title: "Typical"
author: "Fernanda Hansen P. de Moraes"
date: "05/03/2021"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("C:/Users/ferna/Documents/idor/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

# onde estao os arquivos de resultados:
path <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("C:/Users/ferna/Documents/idor/Gyrification/Processamento_longitudinal/V6/data/")

Age.cor = 25

# Prepara os dados para analise
source("05-analises_prep.R")

dados_datasetscomp <- dados_datasetscomp %>% filter(Sample != "HCP500r")

# dados_datasetscomp <- dados_datasetscomp %>% filter(Age == 18 | Age > 18)

# write.csv(dados_datasetscomp,"dados_datasetscomp.csv")
```

# Deaging factors:
```{r}
dados_datasetscomp %>%
  dplyr::select(Sample, ROI, c_AvgThickness, c_logTotalArea, c_logExposedArea) %>%
  unique()

ggplot(dados_datasetscomp, aes(x = ROI, y = c_AvgThickness, color = Sample))+
  geom_point() +
  geom_errorbar(aes(ymin = c_AvgThickness - std_error_c_AvgThickness, ymax = c_AvgThickness + std_error_c_AvgThickness)) +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

ggplot(dados_datasetscomp, aes(x = ROI, y = c_logTotalArea, color = Sample))+
  geom_point() +
  geom_errorbar(aes(ymin = c_logTotalArea - std_error_c_logTotalArea, ymax = c_logTotalArea + std_error_c_logTotalArea)) +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

ggplot(dados_datasetscomp, aes(x = ROI, y = c_logExposedArea, color = Sample))+
  geom_point() +
  geom_errorbar(aes(ymin = c_logExposedArea - std_error_c_logExposedArea, ymax = c_logExposedArea + std_error_c_logExposedArea))  +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

ggplot(dados_datasetscomp, aes(x = ROI, y = c_K, color = Sample))+
  geom_point() +
  geom_errorbar(aes(ymin = c_K - std_error_c_K, ymax = c_K + std_error_c_K))  +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

ggplot(dados_datasetscomp, aes(x = K_age_decay, y = K_age_decay2, color = Sample))+
  geom_point() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) + facet_wrap(ROI ~ .)

ggplot(dados_datasetscomp, aes(x = ROI, y = K_age_decay-K_age_decay2, color = Sample))+
  geom_boxplot() +
  theme_pubr() + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )
```


# Datasets description

We included multiple datasets from different sites to estimate, accounting methodological and "subject" biases, typical values for K, S and I.

```{r description, echo=FALSE}
filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2))
) %>% kable(digits = 2) %>% kable_styling()

filter(dados_datasetscomp,
       Sample != "Mota&Houzel2015",
       ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT =  paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    AT =  paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    AE =  paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K =  paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S =  paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I =  paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  ) %>% kable(digits = 2) %>% kable_styling()


filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic, Gender) %>%
  summarise(
    N = n_distinct(SUBJ)
) %>% kable(digits = 2) %>% kable_styling()
```

# Cortical folding model by Mota & Houzel (Science, 2015)

Applying the cortical folding from Mota & Houzel:

```{r model, echo=FALSE}
dados_datasetscomp <- dados_datasetscomp %>% mutate(Family = "Hominidae", Species = "Homo sapiens")

dados_MH2015 <- mutate(dados_MH2015, ROI = "hemisphere", Diagnostic = "CTL")
dados_datasetscomp_MH <- full_join(dados_datasetscomp, dados_MH2015)

amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)

dados_datasetscomp_MH_2 <- filter(dados_datasetscomp_MH, ROI == "hemisphere")

ggplot(data = dados_datasetscomp_MH_2, aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere", Diagnostic == "CTL"), aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point(aes(color = Sample)) +
    theme_pubr() + guides(shape = FALSE) +
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10)
    )


ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"), aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point(aes(color = Sample)) +
    theme_pubr() + guides(shape = FALSE) +
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10)
    )

ggplot(data = dados_datasetscomp_MH_2, aes(ExposedArea, sqrt(AvgThickness)*TotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 
  
ggplot(data = dados_datasetscomp_MH_2, aes(10^Inorm, 10^Snorm)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

ggplot(data = dados_datasetscomp_MH_2, aes(10^Knorm, 10^Snorm)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

# amostra_Coef %>% kable(digits = 2) %>% kable_styling()

amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere") %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)
amostra_Coef %>% kable(digits = 2) %>% kable_styling()
```

## Behavior of k, K and S across Familys

```{r}
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Sample == "IDOR-ZKMICRO"] <- "Hominidae-ZKMICRO"
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Sample == "IDOR-MICRO"] <- "Hominidae-MICRO"
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Sample == "IDOR-ZK"] <- "Hominidae-ZK"
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Diagnostic == "CCD"] <- "Hominidae-CCD"
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Diagnostic == "AD"] <- "Hominidae-AD"
dados_datasetscomp_MH$Family[dados_datasetscomp_MH$Diagnostic == "MCI"] <- "Hominidae-MCI"

dados_datasetscomp_MH$Family <- as.factor(dados_datasetscomp_MH$Family)

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(Family, k, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + ylim(0, 0.5)

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(x = Family, y = Knorm, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )  + labs(y = "K norm") + ylim(-0.45, 0)


ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(x = Family, y = 10^Knorm, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )  + labs(y = "10^K norm") + ylim(0, 0.6)

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(Family, S, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(Family, Snorm, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9) 
  ) + labs(y = "S norm") + ylim(0,4)

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(Family, 10^Snorm, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9) 
  ) + labs(y = "10^S norm")

ggplot(filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(Family, Inorm, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

mean_K_I_S <-
  filter(dados_datasetscomp_MH, ROI == "hemisphere") %>% group_by(Family) %>% summarise(
    mean.K = mean(10^Knorm, na.rm = TRUE),
    SD_K = sd(10^Knorm, na.rm = TRUE),
    mean.I = mean(10^Inorm, na.rm = TRUE),
    SD_I = sd(10^Inorm, na.rm = TRUE),
    mean.S = mean(10^Snorm, na.rm = TRUE),
    SD_S = sd(10^Snorm, na.rm = TRUE)
    )


plot_ly(
mean_K_I_S,
  x = ~ mean.K,
  z =  ~ mean.S,
  y =  ~ mean.I,
  color = ~ Family,
text =  ~ Family,
  type = "scatter3d",
  mode = 'markers+text'
) %>% layout(scene = list(
  xaxis = list(title = '10^Knorm'),
  zaxis = list(title = '10^Snorm'),
  yaxis = list(title = '10^Inorm')
))

cols = gg_color_hue(length(levels(dados_datasetscomp_MH$Family)))
cols[levels(dados_datasetscomp_MH$Family)=="Hominidae-ZKMICRO"]="black"
cols[levels(dados_datasetscomp_MH$Family)=="Hominidae-MICRO"]="#CC6666"
cols[levels(dados_datasetscomp_MH$Family)=="Hominidae"]="gray"

ggplot(data = filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Family)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

ggplot(data = filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Family)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols) + ylim(4,5.5) + xlim (3.5, 5)

modela2 <- ggplot(data = filter(dados_datasetscomp_MH, ROI == "hemisphere"), aes(10^Inorm, 10^Snorm)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Family)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

modelb2 <- ggplot(data = filter(dados_datasetscomp_MH, ROI == "hemisphere")
                  , aes(10^Knorm, 10^Snorm)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Family)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)


ggarrange(modela2, modelb2, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")


```

## Only humans

```{r modelo_humanos, echo=FALSE, message=FALSE, warning=FALSE}

dados_datasetscomp2 <- dados_datasetscomp
dados_datasetscomp2$Sample <- as.character(dados_datasetscomp2$Sample)

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR" &
                                  dados_datasetscomp2$Diagnostic == "CTL"] <- "IDOR-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR" &
                                  dados_datasetscomp2$Diagnostic == "AD"] <- "IDOR-AD"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR" &
                                  dados_datasetscomp2$Diagnostic == "MCI"] <- "IDOR-MCI"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-CCD" &
                                  dados_datasetscomp2$Diagnostic == "CCD"] <- "IDOR-CCD"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-CCD" &
                                  dados_datasetscomp2$Diagnostic == "CTL"] <- "IDOR-CCD-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp2$Diagnostic == "ZK"] <- "IDOR-ZK"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp2$Diagnostic == "CHIK"] <- "IDOR-CHIK"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp2$Diagnostic == "PRES ZK"] <- "IDOR-PRESZK"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp2$Diagnostic == "OUTROS"] <- "IDOR-OUTROS"

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "CALTECH" &
                                  dados_datasetscomp2$Diagnostic == "CTL"] <- "CALTECH-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "CALTECH" &
                                  dados_datasetscomp2$Diagnostic == "CCD"] <- "CALTECH-CCD"

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "UCSF" &
                                  dados_datasetscomp2$Diagnostic == "CTL"] <- "UCSF-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "UCSF" &
                                  dados_datasetscomp2$Diagnostic == "CCD"] <- "UCSF-CCD"

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "HCPr900"] <- "HCPr900-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "IXI"] <- "IXI-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "OASIS"] <- "OASIS-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "AOMICPIOP1"] <- "AOMICPIOP1-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "AHEAD"] <- "AHEAD-Control"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "AOMICPIOP2"] <- "AOMICPIOP2-Control"

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "NKI"] <- "NKI-Control"

dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "ADNI" & dados_datasetscomp2$Diagnostic == "AD"] <- "ADNI-AD"
dados_datasetscomp2$Sample[dados_datasetscomp2$Sample == "ADNI"& dados_datasetscomp2$Diagnostic == "CTL"] <- "ADNI-Control"

amostra_Coef <- filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    min_age = min(Age),
    max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "logExposedArea")

slope_semN <- ggplot(amostra_Coef, aes(y = estimate, x = Sample)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="Slope", x = "Sample")

#slope_semN

slope <- ggplot(amostra_Coef, aes(y = estimate, x = Sample)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="Slope", x = "Sample \n N, (age range)") + scale_x_discrete(labels = paste(amostra_Coef$Sample,"\n",amostra_Coef$N,", (",signif(amostra_Coef$min_age,2),"-",signif(amostra_Coef$max_age,2),")"))

slope

amostra_Coef <- filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)

amostras_Coef_age <- filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    min_age = min(Age),
    max_age = max(Age))

amostra_Coef <- full_join(amostra_Coef, amostras_Coef_age) %>% filter(term == "logExposedArea_age_decay")

slope_age_decay <- ggplot(amostra_Coef, aes(y = estimate, x = Sample)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_point() + geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="Slope (age corrected)", x = "Sample \n N, (age range)") + scale_x_discrete(labels = paste(amostra_Coef$Sample,"\n",amostra_Coef$N,", (",signif(amostra_Coef$min_age,2),"-",signif(amostra_Coef$max_age,2),")"))

slope_age_decay

ggsave("slope.png", plot = slope, dpi=1200, width = 18, height = 15, units = "cm", device = "png")

ggsave("slope_semN.png", plot = slope_semN, dpi=1200, width = 18, height = 15, units = "cm", device = "png")

ggsave("slope_age_decay.png", plot = slope_age_decay, dpi=1200, width = 18, height = 15, units = "cm", device = "png")

slope2 <- ggarrange(slope, slope_age_decay,labels = c("A", "B"), nrow = 1, ncol = 2, font.label = list(size = 11), common.legend = TRUE, legend = "top")
ggsave("slope2.png", plot = slope2, dpi=1200, width = 18, height = 12, units = "cm", device = "png")

dados_datasetscomp2$Sample <- as.factor(dados_datasetscomp2$Sample)

ggplot(
  filter(dados_datasetscomp2, ROI == "hemisphere"),
  aes(ExposedArea, sqrt(AvgThickness)*TotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp2$SUBJ)
  ))

ggplot( filter(dados_datasetscomp2, ROI == "hemisphere"),
        aes(10^logExposedArea_age_decay, 10^(1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay), color = Sample, fill = Sample)
) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
    theme_pubr() + labs(x = "ExposedArea (age corrected)", y = "sqrt(AvgThickness)*TotalArea (age corrected)" ,  caption = paste(
        "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
        n_distinct(dados_datasetscomp2$SUBJ)
    ))


ggplot( filter(dados_datasetscomp2, ROI == "hemisphere", Age < 6),
        aes(10^logExposedArea_age_decay, 10^(1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay), color = Sample, fill = Sample)
) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
    theme_pubr() + labs(x = "ExposedArea (age corrected)", y = "sqrt(AvgThickness)*TotalArea (age corrected)" ,  caption = paste(
        "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
        n_distinct(dados_datasetscomp2$SUBJ)
    ))

ggplot( filter(dados_datasetscomp2, ROI == "hemisphere", Age < 6),
        aes(logExposedArea_age_decay, (1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay), color = Sample, fill = Sample)
) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
    theme_pubr() + labs(x = "logExposedArea (age corrected)", y = "1 / 2 * logAvgThickness + logTotalArea (age corrected)" ,  caption = paste(
        "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
        n_distinct(dados_datasetscomp2$SUBJ)
    ))

ggplot(
  filter(dados_datasetscomp2, ROI == "hemisphere"),
  aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp2$SUBJ)
  ))

ggplot(
  filter(dados_datasetscomp2, ROI == "hemisphere"),
  aes(logExposedArea_age_decay, 1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp2$SUBJ)
  ))

 ggplot( filter(dados_datasetscomp2, ROI == "hemisphere"),
  aes(10^logExposedArea_age_decay, 10^(1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay), color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  #geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp2$SUBJ)
  ))

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic != "AD" , Diagnostic != "MCI", Diagnostic != "OUTROS"), aes(x = Sample, y = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
    geom_boxplot()+
    theme_pubr() +
    guides(alpha = FALSE) + 
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    )  + labs(y = "K") + ylim(-0.7, 0)

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic != "AD" , Diagnostic != "MCI", Diagnostic != "OUTROS"), aes(x = Sample, y = K_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
    geom_boxplot()+
    theme_pubr() +
    guides(alpha = FALSE) + 
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    )  + labs(y = "K (age corrected)") + ylim(-0.7, 0)

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic != "AD" , Diagnostic != "MCI", Diagnostic != "OUTROS"), aes(x = Sample, y = 10^Knorm, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
    geom_boxplot()+
    theme_pubr() +
    guides(alpha = FALSE) + 
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    )  + labs(y = "10^K norm") + ylim(0, 0.6)

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic != "AD" , Diagnostic != "MCI", Diagnostic != "OUTROS"), aes(x = Sample, y = 10^Knorm_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
    geom_boxplot()+
    theme_pubr() +
    guides(alpha = FALSE) + 
    theme(
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 10),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust = 1, size=9)
    )  + labs(y = "10^K norm (age corrected)") + ylim(0, 0.6)

paste("Verificando a diferenca entre o coeficiente obtido para a Sample e o teorico de 5/4, qual o valor p deste teste?", test_coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp2, ROI == "hemisphere"), na.action = na.omit), 2, 1.25))

mean_K_I_S <-
  filter(dados_datasetscomp2, ROI == "hemisphere") %>% group_by(Sample, Diagnostic) %>% summarise(
    mean.K = mean(Knorm, na.rm = TRUE),
    SD_K = sd(Knorm, na.rm = TRUE),
    mean.I = mean(Inorm, na.rm = TRUE),
    SD_I = sd(Inorm, na.rm = TRUE),
    mean.S = mean(Snorm, na.rm = TRUE),
    SD_S = sd(Snorm, na.rm = TRUE)
    )

plot_ly(
mean_K_I_S,
  x = ~ mean.K,
  z =  ~ mean.S,
  y =  ~ mean.I,
  color = ~ Sample,
text =  ~ Sample,
  type = "scatter3d",
  mode = 'markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'Knorm'),
  zaxis = list(title = 'Snorm', scaleanchor = "x"),
  yaxis = list(title = 'Inorm', scaleanchor = "x")
))

mean_K_I_S <-
  filter(dados_datasetscomp2, ROI == "hemisphere") %>% group_by(Sample, Diagnostic) %>% summarise(
    mean.K = mean(10^Knorm, na.rm = TRUE),
    SD_K = sd(10^Knorm, na.rm = TRUE),
    mean.I = mean(10^Inorm, na.rm = TRUE),
    SD_I = sd(10^Inorm, na.rm = TRUE),
    mean.S = mean(10^Snorm, na.rm = TRUE),
    SD_S = sd(10^Snorm, na.rm = TRUE)
    )

plot_ly(
mean_K_I_S,
  x = ~ mean.K,
  z =  ~ mean.S,
  y =  ~ mean.I,
  color = ~ Sample,
text =  ~ Sample,
  type = "scatter3d",
  mode = 'markers+text'
) %>% layout(scene = list(
  xaxis = list(title = '10^Knorm'),
  zaxis = list(title = '10^Snorm', scaleanchor = "x"),
  yaxis = list(title = '10^Inorm', scaleanchor = "x")
))

```

```{r}
ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = AvgThickness)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = TotalArea)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = ExposedArea)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))
```


```{r}
ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = K)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = 10^Knorm)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))
```

```{r}
ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
      aes(x = Age, y = K_age_decay)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [years]") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = 10^Knorm_age_decay)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp2, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = 10^Snorm_age_decay)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
```

# Mapping

## CTL

```{r mapping}
paste("Total number of CTL subjects =", n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$SUBJ))
paste("Age range CTL. Min age = ", min(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age), "; max age = ", max(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age))

figS6a <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age , y = K)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = (Age*12*4)+40 , y = K)) +
    geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
    geom_smooth(color = "black", method = "lm") + geom_vline(xintercept = 40, linetype = "dashed") +
    theme_pubr() +
    guides(alpha = FALSE)+ 
    labs(x = "Age [weeks] (age of birth defined as 40 weeks)") +
    theme(axis.title = element_text(size = 11),
          axis.text = element_text(size = 10), text = element_text(size = 10)) + xlim(0,1000)

#figS6a

figS6b <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = S)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")
#figS6b

figS6c <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = I)) + geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) + 
  geom_smooth(color = "black", method = "lm") + theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")
 # figS6c      

figS6 <- ggarrange(figS6a, ggarrange(figS6b, figS6c,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

figS6

ggsave("figS6.pdf", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "pdf")
ggsave("figS6.png", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$K, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$S, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$I, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)
```

# Sem AHEAD e HCP
## K \~ Age

```{r eval=FALSE, include=FALSE}
dados_datasetscomp_rate <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control", Sample != "HCPr900", Sample != "AHEAD")
dados_datasetscomp_rate$Diagnostic <- factor(dados_datasetscomp_rate$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate$Sample <- as.factor(dados_datasetscomp_rate$Sample)

N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))

m.1 <- lme4::lmer(K ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_K_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1))

sampleeff.K <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="K variation", x = "Sample")

sampleeff.K

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )
```

## S \~ Age

```{r eval=FALSE, include=FALSE}
m.1 <- lme4::lmer(S ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")

pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_S_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_S_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.S = s$coefficients[2,1]
b.S = s$coefficients[1,1]
a.S.se = s$coefficients[2,2]
b.S.se = s$coefficients[1,2]
lm.S.se = s$sigma
RSE.S = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1)) 
# re_sample <- filter(re, grpvar == "Sample") %>% mutate(grp = factor(name, levels=c("ADNI", "AHEAD", "AOMICPIOP1", "AOMICPIOP2", "HCPr900", "IDOR", "NKI", "OASIS"))
        
sampleeff.S <- ggplot( filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "S variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

```

## I \~ Age

```{r eval=FALSE, include=FALSE}
m.1 <- lme4::lmer(I ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_I_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_I_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.I = s$coefficients[2,1]
b.I = s$coefficients[1,1]
a.I.se = s$coefficients[2,2]
b.I.se = s$coefficients[1,2]
lm.I.se = s$sigma
RSE.I = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1))

sampleeff.I <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "I variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

```

```{r eval=FALSE, include=FALSE}
paste("RSE K = ", signif(RSE.K,2)," - Erro da amostra em idade (mixedmodel) K: ", signif(((max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.K/(max(dados_datasetscomp_rate$K)-min(dados_datasetscomp_rate$K))),2))

paste("RSE S = ",signif(RSE.S,2)," - Erro da amostra em idade (mixedmodel) S: ", (max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.S/(max(dados_datasetscomp_rate$S)-min(dados_datasetscomp_rate$S)))

paste("RSE I = ",signif(RSE.I,2)," - Erro da amostra em idade (mixedmodel) I: ", signif(((max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.I/(max(dados_datasetscomp_rate$I)-min(dados_datasetscomp_rate$I))),2))
```

# Sem outlier
## K \~ Age

```{r eval=FALSE, include=FALSE}
filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control") %>%
  mutate(K_outlier = is_outlier(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")$K)) %>%
  filter(K_outlier == TRUE) %>%
  dplyr::select(c(SUBJ, Age, Gender, Diagnostic, Sample)) %>% unique()

outlier_subj <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control") %>%
  mutate(K_outlier = is_outlier(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")$K)) %>%
  filter(K_outlier == TRUE) %>%
  dplyr::select(c(SUBJ, Age, Gender, Diagnostic, Sample)) %>% unique()

paste("N outliers = ", n_distinct((filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control") %>%
  mutate(K_outlier = is_outlier(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")$K)) %>%
  filter(K_outlier == TRUE))$SUBJ))

dados_datasetscomp_rate <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")  %>%
  anti_join(outlier_subj)

dados_datasetscomp_rate$Diagnostic <- factor(dados_datasetscomp_rate$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate$Sample <- as.factor(dados_datasetscomp_rate$Sample)

N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))

m.1 <- lme4::lmer(K ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_K_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1))

sampleeff.K <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="K variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )
```

## S \~ Age

```{r eval=FALSE, include=FALSE}
m.1 <- lme4::lmer(S ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")

pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_S_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_S_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.S = s$coefficients[2,1]
b.S = s$coefficients[1,1]
a.S.se = s$coefficients[2,2]
b.S.se = s$coefficients[1,2]
lm.S.se = s$sigma
RSE.S = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1)) 
# re_sample <- filter(re, grpvar == "Sample") %>% mutate(grp = factor(name, levels=c("ADNI", "AHEAD", "AOMICPIOP1", "AOMICPIOP2", "HCPr900", "IDOR", "NKI", "OASIS"))
        
sampleeff.S <- ggplot( filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "S variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

```

## I \~ Age

```{r eval=FALSE, include=FALSE}
m.1 <- lme4::lmer(I ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk)

m.lstk <-
  as_tibble(m.lstk) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL , 2), ";", signif(asymp.UCL , 2)),
    N_SUBJ = N_SUBJ$N_SUBJ
  ) %>% dplyr::select(c(Diagnostic, N_SUBJ, TX, CI))
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_I_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_I_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.I = s$coefficients[2,1]
b.I = s$coefficients[1,1]
a.I.se = s$coefficients[2,2]
b.I.se = s$coefficients[1,2]
lm.I.se = s$sigma
RSE.I = sigma.hat(m.1)$sigma$Sample[1]

re <- as_tibble(ranef(m.1))

sampleeff.I <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "I variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )
```

```{r eval=FALSE, include=FALSE}
paste("RSE K = ", signif(RSE.K,2)," - Erro da amostra em idade (mixedmodel) K: ", signif(((max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.K/(max(dados_datasetscomp_rate$K)-min(dados_datasetscomp_rate$K))),2))

paste("RSE S = ",signif(RSE.S,2)," - Erro da amostra em idade (mixedmodel) S: ", (max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.S/(max(dados_datasetscomp_rate$S)-min(dados_datasetscomp_rate$S)))

paste("RSE I = ",signif(RSE.I,2)," - Erro da amostra em idade (mixedmodel) I: ", signif(((max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*RSE.I/(max(dados_datasetscomp_rate$I)-min(dados_datasetscomp_rate$I))),2))
```

# Decreasing rate

```{r}
dados_datasetscomp_rate <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")
dados_datasetscomp_rate$Diagnostic <- factor(dados_datasetscomp_rate$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate$Sample <- as.factor(dados_datasetscomp_rate$Sample)

N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))
```


## AvgThickness \~ Age

```{r}
m.1 <- lme4::lmer(AvgThickness ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableT <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgT/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "Avg Cortical Thickness", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.T = s$coefficients[2,1]
b.T = s$coefficients[1,1]
a.T.se = s$coefficients[2,2]
b.T.se = s$coefficients[1,2]
lm.T.se = sigma(m.1)
RSE.T = sigma.hat(m.1)$sigma$Sample[1]

a.T.AD = s$coefficients[2,1] + s$coefficients[6,1]
b.T.AD = s$coefficients[1,1] + s$coefficients[4,1]

a.T.MCI = s$coefficients[2,1] + s$coefficients[5,1]
b.T.MCI = s$coefficients[1,1] + s$coefficients[3,1]

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="T variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

paste("Rate per cent / year = ", signif(a.T*100/b.T, 2))
```

## GI \~ Age

```{r}
m.1 <- lme4::lmer(AvgThickness ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableGI <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "GI")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'GI/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "GI", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.T = s$coefficients[2,1]
b.T = s$coefficients[1,1]
a.T.se = s$coefficients[2,2]
b.T.se = s$coefficients[1,2]
lm.T.se = sigma(m.1)
RSE.T = sigma.hat(m.1)$sigma$Sample[1]

a.T.AD = s$coefficients[2,1] + s$coefficients[6,1]
b.T.AD = s$coefficients[1,1] + s$coefficients[4,1]

a.T.MCI = s$coefficients[2,1] + s$coefficients[5,1]
b.T.MCI = s$coefficients[1,1] + s$coefficients[3,1]

re <- as_tibble(ranef(m.1))

ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="T variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

paste("Rate per cent / year = ", signif(a.T*100/b.T, 2))
```

## K \~ Age

```{r}
N_SUBJ <- dados_datasetscomp_rate %>% group_by(Diagnostic) %>% summarise(N_SUBJ = n_distinct(SUBJ))

m.1 <- lme4::lmer(K ~ Age * Diagnostic + (1|Sample/Diagnostic) + (1|SUBJ), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableK <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ) 
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_K_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

a.K.AD = s$coefficients[2,1] + s$coefficients[6,1]
b.K.AD = s$coefficients[1,1] + s$coefficients[4,1]

a.K.MCI = s$coefficients[2,1] + s$coefficients[5,1]
b.K.MCI = s$coefficients[1,1] + s$coefficients[3,1]

re <- as_tibble(ranef(m.1))
write.csv(re, "reK.csv")

sampleeff.K <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y ="K variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

eK <- e
```

## S \~ Age

```{r}
m.1 <- lme4::lmer(S ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableS <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_S_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)
fig_S_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.S = s$coefficients[2,1]
b.S = s$coefficients[1,1]
a.S.se = s$coefficients[2,2]
b.S.se = s$coefficients[1,2]
lm.S.se = s$sigma
RSE.S = sigma.hat(m.1)$sigma$Sample[1]

a.S.AD = s$coefficients[2,1] + s$coefficients[6,1]
b.S.AD = s$coefficients[1,1] + s$coefficients[4,1]

a.S.MCI = s$coefficients[2,1] + s$coefficients[5,1]
b.S.MCI = s$coefficients[1,1] + s$coefficients[3,1]

re <- as_tibble(ranef(m.1)) 
write.csv(re, "reS.csv")

# re_sample <- filter(re, grpvar == "Sample") %>% mutate(grp = factor(name, levels=c("ADNI", "AHEAD", "AOMICPIOP1", "AOMICPIOP2", "HCPr900", "IDOR", "NKI", "OASIS"))
        
sampleeff.S <- ggplot( filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "S variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

eS <- e

```

## I \~ Age

```{r}
m.1 <- lme4::lmer(I ~ Age * Diagnostic + (1|Sample/Diagnostic), data = dados_datasetscomp_rate)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableI <- full_join(mean, m.lstk, by = c("Diagnostic")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, TX, CI)) %>% full_join(N_SUBJ)
m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs %>% kable() %>% kable_styling()
 
fig_TX_I_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.3, nudge_y = 0.0003) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- effect("Age:Diagnostic", m.1)
e <- as.data.frame(e)

fig_I_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10), legend.position = "none")

a.I = s$coefficients[2,1]
b.I = s$coefficients[1,1]
a.I.se = s$coefficients[2,2]
b.I.se = s$coefficients[1,2]
lm.I.se = s$sigma
RSE.I = sigma.hat(m.1)$sigma$Sample[1]

a.I.AD = s$coefficients[2,1] + s$coefficients[6,1]
b.I.AD = s$coefficients[1,1] + s$coefficients[4,1]

a.I.MCI = s$coefficients[2,1] + s$coefficients[5,1]
b.I.MCI = s$coefficients[1,1] + s$coefficients[3,1]

re <- as_tibble(ranef(m.1))
write.csv(re, "reI.csv")

sampleeff.I <- ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + labs(y = "I variation", x = "Sample")

ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
  geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

eI <- e

```

## Figures

```{r eval=FALSE, include=FALSE}
eK <- eK %>%
  mutate(K = fit, K.se = se, Knorm = K/sqrt(1 + (1/4)^2 + (5/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, K, K.se, Knorm))
eS <- eS %>%
  mutate(S = fit, S.se = se, Snorm = S/sqrt((3/2)^2 + (3/4)^2 + (9/4)^2)) %>%
  dplyr::select(c(Age, Diagnostic, S, S.se, Snorm))
eI <- eI %>%
  mutate(I = fit, I.se = se, Inorm = I/sqrt(1^2 + 1^2 + 1^2)) %>%
  dplyr::select(c(Age, Diagnostic, I, I.se, Inorm))

e <- full_join(eK, eS) %>%
  full_join(eI) %>% as_tibble()

plot_ly(
e,
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))

plot_ly(
filter(e, Diagnostic == "AD" |Diagnostic == "CTL", Age == "50" | Age == "100"),
  x = ~ Knorm,
  z =  ~ Snorm,
  y =  ~ Inorm,
  color = ~ Diagnostic,
text =  ~ Age,
  type = "scatter3d",
  mode = 'lines+markers+text'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))
```

```{r}
fig_TX_age <- ggarrange(fig_TX_K_age, ggarrange(fig_TX_S_age, fig_TX_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age

fig_age <- ggarrange(fig_K_age, ggarrange(fig_S_age, fig_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_age

fig_sampleeff <- ggarrange(sampleeff.K, ggarrange(sampleeff.S, sampleeff.I,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_sampleeff

ggsave("fig_TX_age.pdf", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age.png", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

ggsave("fig_age.pdf", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_age.png", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

ggsave("fig_sampleeff.png", plot = fig_sampleeff, dpi=1200, width = 18, height = 18, units = "cm", device = "png")
```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, percent, Variable))
tableK <- tableK %>% dplyr::select(c(Diagnostic, percent, Variable))
tableS <- tableS %>% dplyr::select(c(Diagnostic, percent, Variable))
tableI <- tableI %>% dplyr::select(c(Diagnostic, percent, Variable))
tableGI <- tableGI %>% dplyr::select(c(Diagnostic, percent, Variable))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI) %>% full_join(tableGI)

rate %>% kable() %>% kable_styling()

```

# Simulating healthy values

```{r Simulating values with linear regression error (coefficients error propagated), eval=FALSE, include=FALSE}
set.seed(1)

Age <- as_tibble(runif(1000, min=0, max=100))
colnames(Age)[1] <- "Age"
# paste("mean age from the random sample = ",signif(mean(Age$Age),2),"±",signif(sd(Age$Age),2))

pred <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = sqrt((abs(Age) * a.K.se) ^ 2 + b.K.se ^2),
  S = a.S * Age + b.S,
  S.se = sqrt((abs(Age) * a.S.se) ^ 2 + b.S.se ^2),
  I = a.I * Age + b.I,
  I.se = sqrt((abs(Age) * a.I.se) ^ 2 + b.I.se ^2),
  Diagnostic = "CTL-pred",
  ROI = "hemisphere"
)

# paste("a.K = ", signif(a.K,2), ", b.K = ", signif(b.K,2), ", a.K.se = ", signif(a.K.se,2), ", b.K.se = ", signif(b.K.se,2))
# 
# paste("a.S = ", signif(a.S,2), ", b.S = ", signif(b.S,2), ", a.S.se = ", signif(a.S.se,2), ", b.S.se = ", signif(b.S.se,2))
# 
# paste("a.I = ", signif(a.I,2), ", b.I = ", signif(b.I,2), ", a.I.se = ", signif(a.I.se,2), ", b.I.se = ", signif(b.I.se,2))

predictions <- ggplot(pred,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(-0.600, -0.450)

predictions.S <- ggplot(pred,
       aes(x = Age, y = S, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted S") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(9, 9.4)

predictions.I <- ggplot(pred,
       aes(x = Age, y = I, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted I") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(10.1, 10.6)

```

```{r Simulating values with Residual standard error, eval=FALSE, include=FALSE}

pred.rse.data <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = lm.K.se,
  S = a.S * Age + b.S,
  S.se = lm.S.se,
  I = a.I * Age + b.I,
  I.se = lm.I.se,
  Diagnostic = "CTL-rse",
  ROI = "hemisphere"
)

# paste("a.K = ", signif(a.K,2), ", b.K = ", signif(b.K,2), ", lm.K.se = ", signif(lm.K.se,2))
# 
# paste("a.S = ", signif(a.S,2), ", b.S = ", signif(b.S,2), ", lm.S.se = ", signif(lm.S.se,2))
# 
# paste("a.I = ", signif(a.I,2), ", b.I = ", signif(b.I,2), ", lm.I.se = ", signif(lm.I.se,2))

predictions.rse <- ggplot(pred.rse.data,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "RSE K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(-0.600, -0.450)

predictions.S.rse <- ggplot(pred.rse.data,
       aes(x = Age, y = S, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "RSE S") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(9, 9.4)

predictions.I.rse <- ggplot(pred.rse.data,
       aes(x = Age, y = I, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "RSE I") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10)) + ylim(10.1, 10.6)
```

```{r total error lmm, echo=FALSE}
set.seed(1)

Age <- as_tibble(runif(1000, min=0, max=100))
colnames(Age)[1] <- "Age"

simulation <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = 0.025,
  S = a.S * Age + b.S,
  S.se = 0.145, # Confirmar
  I = a.I * Age + b.I,
  I.se = 0.09, # Confirmar
  Diagnostic = "CTL-simulated",
  ROI = "hemisphere"
)

# data <- full_join(pred, simulation)

totalerrorfig <- ggplot(simulation,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "LMM K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

totalerrorfig

# ggplot(simulation, aes(x = Age, y = K, alpha = 0.4)) +
#     geom_point() +
#     geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
#     geom_smooth(color = "black", linetype = 2) +
#     geom_smooth(color = "black", method = "lm") + geom_hline(yintercept = (a.K * 25 + b.K) + K.se) + geom_hline(yintercept = (a.K * 25 + b.K) - K.se) + geom_vline(xintercept = (((a.K * 25 + b.K) - K.se) - b.K) /a.K) + geom_vline(xintercept = (((a.K * 25 + b.K) + K.se) - b.K) /a.K) + geom_vline(xintercept = 25, linetype = "dashed") + geom_hline(yintercept = (a.K * 25 + b.K), linetype = "dashed") + 
#     theme_pubr() +
#     guides(alpha = FALSE)+ 
#     labs(x = "Age [years]", y = "Simulated K") +
#     theme(axis.title = element_text(size = 11),
#           axis.text = element_text(size = 10), text = element_text(size = 10))

# simulationfig.S <- ggplot(simulation,
#        aes(x = Age, y = S, alpha = 0.4)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
#   geom_smooth(color = "black", linetype = 2) +
#   geom_smooth(color = "black", method = "lm") +
#   theme_pubr() +
#   guides(alpha = FALSE)+ 
#   labs(x = "Age [years]", y = "Simulated S") +
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10), text = element_text(size = 10))
# 
# simulationfig.I <- ggplot(simulation,
#        aes(x = Age, y = I, alpha = 0.4)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
#   geom_smooth(color = "black", linetype = 2) +
#   geom_smooth(color = "black", method = "lm") +
#   theme_pubr() +
#   guides(alpha = FALSE)+ 
#   labs(x = "Age [years]", y = "Simulated I ") +
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10), text = element_text(size = 10))


```

```{r Simulating values with baeysian approach values, echo=FALSE}
a.K = -0.00087 # extraído do modelo do Victor
b.K = -0.47 # extraído do modelo do Victor
K.se = 0.02

a.S = -0.000825 # extraído do modelo do Victor
b.S = -10.645 # extraído do modelo do Victor
S.se = .087

a.I = -0.001925 # extraído do modelo do Victor
b.I = -9.827 # extraído do modelo do Victor
I.se = 0.07

simulation <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = 0.02,
  S = a.S * Age + b.S,
  S.se = 0.087, # Confirmar
  I = a.I * Age + b.I,
  I.se = 0.07, # Confirmar
  Diagnostic = "CTL-simulated",
  ROI = "hemisphere"
)

# data <- full_join(pred, simulation)

simulationfig <- ggplot(simulation,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Bayesian Model K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

# ggplot(simulation, aes(x = Age, y = K, alpha = 0.4)) +
#     geom_point() +
#     geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
#     geom_smooth(color = "black", linetype = 2) +
#     geom_smooth(color = "black", method = "lm") + geom_hline(yintercept = (a.K * 25 + b.K) + K.se) + geom_hline(yintercept = (a.K * 25 + b.K) - K.se) + geom_vline(xintercept = (((a.K * 25 + b.K) - K.se) - b.K) /a.K) + geom_vline(xintercept = (((a.K * 25 + b.K) + K.se) - b.K) /a.K) + geom_vline(xintercept = 25, linetype = "dashed") + geom_hline(yintercept = (a.K * 25 + b.K), linetype = "dashed") + 
#     theme_pubr() +
#     guides(alpha = FALSE)+ 
#     labs(x = "Age [years]", y = "Simulated K") +
#     theme(axis.title = element_text(size = 11),
#           axis.text = element_text(size = 10), text = element_text(size = 10))

# simulationfig.S <- ggplot(simulation,
#        aes(x = Age, y = S, alpha = 0.4)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
#   geom_smooth(color = "black", linetype = 2) +
#   geom_smooth(color = "black", method = "lm") +
#   theme_pubr() +
#   guides(alpha = FALSE)+ 
#   labs(x = "Age [years]", y = "Simulated S") +
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10), text = element_text(size = 10))
# 
# simulationfig.I <- ggplot(simulation,
#        aes(x = Age, y = I, alpha = 0.4)) +
#   geom_point() +
#   geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
#   geom_smooth(color = "black", linetype = 2) +
#   geom_smooth(color = "black", method = "lm") +
#   theme_pubr() +
#   guides(alpha = FALSE)+ 
#   labs(x = "Age [years]", y = "Simulated I ") +
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10), text = element_text(size = 10))


```

```{r eval=FALSE, include=FALSE}
paste("Erro da amostra em idade (bayes) K: ", (max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*K.se/(max(dados_datasetscomp_rate$K)-min(dados_datasetscomp_rate$K)))

paste("Erro da amostra em idade (bayes) S: ", (max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*S.se/(max(dados_datasetscomp_rate$S)-min(dados_datasetscomp_rate$S)))

paste("Erro da amostra em idade (bayes) I: ", (max(dados_datasetscomp_rate$Age)-min(dados_datasetscomp_rate$Age))*I.se/(max(dados_datasetscomp_rate$I)-min(dados_datasetscomp_rate$I)))
```

## Comparing methods

We estimate the coefficients and uncertainties with two methods: (a) linear regression and (b) Bayesian modeling. From (a) we calculated the linear regression model error, based on the coefficients errors, and the fluctuation around a certain value of age, with the Residual Standard Error; (b) estimated the fluctuation around a certain value of age.

```{r}
cbPalette <- c("#000000", "#FF0000")

coefsK <- read_excel("coefs.xlsx", sheet = "K")

figcoefsK <- ggplot(coefsK, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="K systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefsS <- read_excel("coefs.xlsx", sheet = "S")

figcoefsS <- ggplot(coefsS, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="S systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefsI <- read_excel("coefs.xlsx", sheet = "I")

figcoefsI <- ggplot(coefsI, aes(y = condval, x = as.character(grp), color = model, group = model)) +
  geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2, position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) + geom_hline(yintercept = 0, linetype = "dashed") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) +
  labs(y ="S systematic shift", x = "Sample") +
  scale_color_manual(values=cbPalette)

coefs <- ggarrange(figcoefsK, ggarrange(figcoefsS, figcoefsI,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ggsave("coefs.png", plot = coefs, width = 18, height = 22, units = "cm", device = "png")
```


```{r}
# healthyvalues <- ggarrange(predictions, simulationfig, predictions.S, simulationfig.S, predictions.I, simulationfig.I, nrow = 3, ncol = 2, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 11))

#healthyvalues

#healthyvalues2 <- ggarrange(predictions, predictions.rse, simulationfig, predictions.S, predictions.S.rse, simulationfig.S, predictions.I, predictions.I.rse, simulationfig.I, nrow = 3, ncol = 3, labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"), font.label = list(size = 11))

#healthyvalues2 <- ggarrange(simulationfig, ggarrange(predictions, predictions.rse, predictions.S, predictions.S.rse, predictions.I, predictions.I.rse, nrow = 3, ncol = 2, labels = c("B", "C", "D", "E", "F", "G")),labels = c("A"), nrow = 1, ncol = 2, font.label = list(size = 11))

#healthyvalues2

healthyvalues3 <- ggarrange(simulationfig, totalerrorfig, nrow = 1, ncol = 2, labels = c("A","B"), font.label = list(size = 11))

healthyvalues3

#ggsave("healthyvalues.png", plot = healthyvalues, width = 18, height = 22, units = "cm", device = "png")
#ggsave("healthyvalues.png", plot = healthyvalues2, width = 18, height = 18, units = "cm", device = "png")
```

# LOBES

```{r}
dados_datasetscomp_rate_lobes <- filter(dados_datasetscomp, ROI != "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-CCD-Control")
dados_datasetscomp_rate_lobes$Diagnostic <- factor(dados_datasetscomp_rate_lobes$Diagnostic, levels = c("CTL", "MCI","AD"))
dados_datasetscomp_rate_lobes$Sample <- as.factor(dados_datasetscomp_rate_lobes$Sample)

N_SUBJ <- dados_datasetscomp_rate_lobes %>% group_by(Diagnostic, ROI) %>% summarise(N_SUBJ = n_distinct(SUBJ))

```


### AvgThickness \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(AvgThickness ~ Age * Diagnostic * ROI + (1|Sample/Diagnostic), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableT <- full_join(mean, m.lstk, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "T")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'AvgThickness/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "AvgThickness", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

# re <- as_tibble(ranef(m.1))
# 
# ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   ) + labs(y ="K variation", x = "Sample")
# 
# ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   )

```

### K \~ Age
```{r echo=FALSE}
m.1 <- lme4::lmer(K ~ Age * Diagnostic * ROI + (1|Sample/Diagnostic), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableK <- full_join(mean, m.lstk, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "K")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

pairs <- as_tibble(pairs) %>%
  mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>%
  mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

## Within regions comparison

TX_K_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_K_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_K_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "K", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

# re <- as_tibble(ranef(m.1))
# 
# ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   ) + labs(y ="K variation", x = "Sample")
# 
# ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   )

```

### S \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(S ~ Age * Diagnostic * ROI + (1|Sample/Diagnostic), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
#glance(m.1)
#tidy(m.1) %>% kable() %>% kable_styling()
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableS <- full_join(mean, m.lstk, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "S")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_S_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_S_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_S_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "S", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

# re <- as_tibble(ranef(m.1))
# 
# ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   ) + labs(y ="K variation", x = "Sample")
# 
# ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   )
```

### I \~ Age

```{r echo=FALSE}
m.1 <- lme4::lmer(I ~ Age * Diagnostic * ROI + (1|Sample/Diagnostic), data = dados_datasetscomp_rate_lobes)

performance::check_model(m.1)

anova(m.1)
summary(m.1)
s <- summary(m.1)
sigma.hat(m.1)
r.squaredGLMM(m.1)

mean <- lsmeans(m.1, ~ Diagnostic*ROI, var="Age")
m.lstk <- lstrends(m.1, ~ Diagnostic*ROI, var="Age")
pairs <- pairs(m.lstk) 

mean <- as_tibble(mean)
m.lstk <- as_tibble(m.lstk)

tableI <- full_join(mean, m.lstk, by = c("Diagnostic", "ROI")) %>% mutate(percent = Age.trend*100/abs(lsmean), Variable = "I")

m.lstk %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(asymp.LCL, 2), ";", signif(asymp.UCL, 2)),
  ) %>% dplyr::select(c(Diagnostic, ROI, TX, CI)) %>% full_join(N_SUBJ)

m.lstk %>% kable() %>% kable_styling()

coefs <- data.frame(coef(summary(m.1)))
coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
coefs

pairs <- as_tibble(pairs) %>% mutate(Contrast.1 = str_split(contrast, pattern = " - ", simplify = TRUE)[,1], Contrast.2 = str_split(contrast, pattern = " - ", simplify = TRUE)[,2]) %>% mutate(Diagnostic.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,1], ROI.1 = str_split(Contrast.1, pattern = " ", simplify = TRUE)[,2], Diagnostic.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,1], ROI.2 = str_split(Contrast.2, pattern = " ", simplify = TRUE)[,2]) %>%
  mutate(contrast = str_c(Diagnostic.1, Diagnostic.2 ,sep = "-"), contrast_ROI = str_c(ROI.1, ROI.2 ,sep = "-"))

## Within regions comparion

TX_I_Within_regions <- ggplot(data = filter(pairs, ROI.1 == ROI.2), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(ROI.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

## Within diagnostics 

TX_I_Within_DIAG <- ggplot(data = filter(pairs, Diagnostic.1 == Diagnostic.2), aes(
    x = contrast_ROI,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj ", signif(p.value, digits = 2))), nudge_x = 0.4, nudge_y = 0.0003) +
  facet_wrap(Diagnostic.1 ~.) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Contrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), axis.text.x = element_text(angle = 45, hjust = 1, size=9))

e <- effect("Age:Diagnostic:ROI", m.1)
e <- as.data.frame(e)

fit_I_lobes <- ggplot(e, aes(x = Age, y = fit,ymin=lower, ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(x = "Age [years]", y = "I", shape = "Diagnostic") + facet_wrap(. ~ ROI) +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

a.K = s$coefficients[2,1]
b.K = s$coefficients[1,1]
a.K.se = s$coefficients[2,2]
b.K.se = s$coefficients[1,2]
lm.K.se = sigma(m.1)
RSE.K = sigma.hat(m.1)$sigma$Sample[1]

# re <- as_tibble(ranef(m.1))
# 
# ggplot(filter(re, grpvar == "Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   ) + labs(y ="K variation", x = "Sample")
# 
# ggplot(filter(re, grpvar == "Diagnostic:Sample"), aes(y = condval, x = as.character(grp))) +
#   geom_errorbar(aes(ymin = condval+1.96*condsd, ymax = condval-1.96*condsd), width = 0.2) +
#   geom_point() + geom_hline(yintercept = 0, linetype = "dashed") +
#   theme_pubr() + 
#   theme(axis.title = element_text(size = 11),
#     axis.text = element_text(size = 10),
#     text = element_text(size = 10),
#     axis.text.x = element_text(angle = 45, hjust = 1, size=9)
#   )

```

```{r echo=FALSE}
tableT <- tableT %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableK <- tableK %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableS <- tableS %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))
tableI <- tableI %>% dplyr::select(c(Diagnostic, ROI, Age.trend, SE.y, percent, Variable))

rate <- full_join(tableT, tableK) %>% full_join(tableS) %>% full_join(tableI) %>% mutate(percent = signif(percent, 2), TX = paste(signif(Age.trend, 2), "±", signif(SE.y, 2)))
rate
```

## Figures

```{r}

fig_TX_age_lobes_ROI <- ggarrange(TX_K_Within_regions, TX_S_Within_regions, TX_I_Within_regions,labels = c("A","B","C"), nrow = 3, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_lobes_DIAG <- ggarrange(TX_K_Within_DIAG, TX_S_Within_DIAG, TX_I_Within_DIAG,labels = c("A","B","C"), nrow = 3, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_lobes_ROI
fig_TX_age_lobes_DIAG

#ggsave("fig_TX_age.pdf", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age_lobes_ROI.png", plot = fig_TX_age_lobes_ROI, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

#ggsave("fig_age.pdf", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age_lobes_DIAG.png", plot = fig_TX_age_lobes_DIAG, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

#ggsave("fig_sampleeff.png", plot = fig_sampleeff, dpi=1200, width = 18, height = 18, units = "cm", device = "png")

fit_lobes <- ggarrange(fit_K_lobes, ggarrange(fit_S_lobes, fit_I_lobes,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fit_S_lobes

ggsave("fit_lobes.png", plot = fit_lobes, dpi=1200, width = 18, height = 22, units = "cm", device = "png")

# ggsave("fit_K_lobes.png", plot = fit_K_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")
# 
# ggsave("fit_S_lobes.png", plot = fit_S_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")
# 
# ggsave("fit_I_lobes.png", plot = fit_I_lobes, dpi=1200, width = 11, height = 15, units = "cm", device = "png")
```
