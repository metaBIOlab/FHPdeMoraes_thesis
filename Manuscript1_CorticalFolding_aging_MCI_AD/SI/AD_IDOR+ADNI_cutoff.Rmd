---
title: "CSF biomarkers cut-off proposal for Memory Clinic-IDOR subjects"
author: "Fernanda Hansen P. de Moraes"
date: "13/07/2021"
output: 
  html_document: 
    toc: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("~/Documentos/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

# onde estao os arquivos de resultados:
path <- str_c("~/Documentos/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("~/Documentos/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("~/Documentos/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("~/Documentos/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("~/Documentos/Gyrification/Processamento_longitudinal/V6/data/")

Age.cor = 25

# Prepara os dados para analise
source("05-analises_prep.R")
source("harmonization.R")

dados_datasetscomp <- dados_datasetscomp %>%
    filter(Sample == "IDOR" | Sample == "ADNI")

dados_datasetscomp_hemi <- dados_datasetscomp %>%
    filter(ROI == "hemisphere")

CSF <- dados_datasetscomp_hemi %>%
   mutate(Ab42 = ifelse(!is.na(`AB1-42`),`AB1-42`,ABETA)) %>%
  filter(!is.na(TAU), !is.na(Ab42))

set.seed(1)

```

# Data description

```{r}
filter(CSF) %>%
  group_by(Diagnostic, Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
#   age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT = paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
# AT = paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
# AE = paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K = paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S = paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I = paste(signif(mean(I), 2), "±", signif(sd(I), 2)),
    TAU = paste(signif(mean(TAU, na.rm = TRUE), 2), "±", signif(sd(TAU, na.rm = TRUE), 2)),
    ABETA = paste(signif(mean(`AB1-42`, na.rm = TRUE), 2), "±", signif(sd(`AB1-42`, na.rm = TRUE), 2))
  ) %>% kable(digits = 2) %>% kable_styling()


filter(dados_datasetscomp_hemi) %>%
  group_by(Diagnostic, Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
#   age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT = paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
# AT = paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
# AE = paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K = paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S = paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I = paste(signif(mean(I), 2), "±", signif(sd(I), 2)) ) %>%
  kable(digits = 2) %>%
kable_styling()
```

```{r}
ggplot(dados_datasetscomp_hemi, aes(x = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_density() +
  guides(alpha = "none") +
  theme_pubr()

ggplot(dados_datasetscomp_hemi, aes(x = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_density() +
  guides(alpha = "none") +
  theme_pubr() +
  facet_grid(. ~ Sample )

ggplot(dados_datasetscomp_hemi, aes(x = K_shiftc, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_density() +
  guides(alpha = "none") +
  theme_pubr() +
  facet_grid(. ~ Sample )

ggplot(dados_datasetscomp_hemi, aes(x = K_shiftc, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_density() +
  guides(alpha = "none") +
  theme_pubr() 

ggplot(CSF, aes(x = Diagnostic, y = Ab42)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means(method = "anova", label.y = 1500) +
  guides(alpha = "none") +
  theme_pubr() +
  facet_grid(. ~ Sample )

summary(aov(Ab42 ~ Diagnostic*Sample, CSF))
TukeyHSD(aov(Ab42 ~ Diagnostic*Sample, CSF))

ggplot(CSF, aes(x = Diagnostic, y = TAU)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means(method = "anova", label.y = 1300) +
  guides(alpha = "none") +
  theme_pubr() +
  facet_grid(. ~ Sample )

summary(aov(TAU ~ Diagnostic*Sample, CSF))
TukeyHSD(aov(TAU ~ Diagnostic*Sample, CSF))

```

## Lobes
```{r}
ggplot(dados_datasetscomp, aes(x = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) +
  geom_density() +
  guides(alpha = "none") +
  theme_pubr() +
  facet_grid(ROI ~ Sample )

```


# How to define CTL A+ or T+? What should be the cutoff?

```{r}
CSF <- CSF %>%
  mutate(
    diseased = ifelse(Diagnostic == "AD" | Diagnostic == "MCI", "yes", "no")
  )
```

# CTL vs AD

Multiple Optimal Cutpoint analysis to infer the methodological differences. Positive class: AD; Negative class: NDC; Direction: defined automatic for each CSF biomarkers.

## Ab1-42

```{r}
cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    Ab42,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_metric,
    metric = sum_sens_spec,
    na.rm = TRUE
  )
summary(cpAB142)
plot(cpAB142)

# cpAB142 <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
#     Ab42,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpAB142)
# plot(cpAB142)

cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    Ab42,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_metric,
    metric = odds_ratio,
    na.rm = TRUE
  )
summary(cpAB142)
plot(cpAB142)

cpAB142 <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    Ab42,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 100  )
summary(cpAB142)
plot(cpAB142)

```

## comparing with published cut-offs (Lehmann et al., 2018)

```{r}

ggplot(CSF, aes(x = Diagnostic, y = Ab42, color = Sample)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  geom_hline(aes(yintercept = 500), linetype = "dashed") +
  guides(alpha = "none") +
  labs(caption = "Dashed line - Lehmann et al.,2108; Solid line - proposed cutpoint for each dataset") +
  facet_grid(. ~ Sample) +
  geom_hline(data  = cpAB142, aes(yintercept = optimal_cutpoint, colour = subgroup)) +
  theme_pubr()

```

## t-Tau

```{r}
cpTAU <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    TAU,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_metric,
    metric = sum_sens_spec,
    na.rm = TRUE
  )
summary(cpTAU)
plot(cpTAU)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
#     TAU,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

cpTAU <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    TAU,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_metric,
    metric = odds_ratio,
    na.rm = TRUE
  )
summary(cpTAU)
plot(cpTAU)

cpTAU <-
  cutpointr(
    filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
    TAU,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 100
  )
summary(cpTAU)
plot(cpTAU)

```

## N (K is our degeneration marker here)

```{r}
# cpK <-
#   cutpointr(
#     filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
#              Diagnostic == "CTL"),
#     K,
#     Diagnostic,
#     Sample,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpK)
# plot(cpK)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
#     TAU,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)
# 
# cpK <-
#   cutpointr(
#     filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
#              Diagnostic == "CTL"),
#     K,
#     Diagnostic,
#     Sample,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpK)
# plot(cpK)

cpK <-
  cutpointr(
    filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
             Diagnostic == "CTL"),
    K,
    Diagnostic,
    Sample,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 100
  )
summary(cpK)
plot(cpK)

```

### Harmonized

```{r}
# cpKshift <-
#   cutpointr(
#     filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
#              Diagnostic == "CTL"),
#     K_shiftc,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = sum_sens_spec,
#     na.rm = TRUE
#   )
# summary(cpKshift)
# plot(cpKshift)

# cpTAU <-
#   cutpointr(
#     filter(CSF, Diagnostic == "AD" | Diagnostic == "CTL"),
#     TAU,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = youden,
#     na.rm = TRUE
#   )
# summary(cpTAU)
# plot(cpTAU)

# cpKshift <-
#   cutpointr(
#     filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
#              Diagnostic == "CTL"),
#     K_shiftc,
#     Diagnostic,
#     pos_class = "AD",
#     neg_class = "CTL",
#     method = maximize_metric,
#     metric = odds_ratio,
#     na.rm = TRUE
#   )
# summary(cpKshift)
# plot(cpKshift)

cpKshift <-
  cutpointr(
    filter(dados_datasetscomp_hemi, Diagnostic == "AD" |
             Diagnostic == "CTL"),
    K_shiftc,
    Diagnostic,
    pos_class = "AD",
    neg_class = "CTL",
    method = maximize_boot_metric,
    metric = sum_sens_spec,
    na.rm = TRUE,
    boot_runs = 100
  ) 
summary(cpKshift)
plot(cpKshift)

```

# Is K different in CTL with A+ or T+? (cut-off subsample)

```{r}
CSF <- CSF %>%
  mutate(
    N = ifelse(
      Sample == "ADNI",
      ifelse(
        K < filter(cpK, subgroup == "ADNI")$optimal_cutpoint,
        str_c("<", signif(
          filter(cpK, subgroup == "ADNI")$optimal_cutpoint, 2
        )),
        str_c(">", signif(
          filter(cpK, subgroup == "ADNI")$optimal_cutpoint, 2
        ))
      ),
      ifelse(
        K < filter(cpK, subgroup == "IDOR")$optimal_cutpoint,
        str_c("<", signif(
          filter(cpK, subgroup == "IDOR")$optimal_cutpoint, 2
        )),
        str_c(">", signif(
          filter(cpK, subgroup == "IDOR")$optimal_cutpoint, 2
        ))
      )
    ),
    N_shift = ifelse(K_shift < cpKshift$optimal_cutpoint,
                     str_c("<", signif(cpKshift$optimal_cutpoint, 2)),
                     str_c(">", signif(cpKshift$optimal_cutpoint, 2))), 
    Ab = ifelse(
      Sample == "ADNI",
      ifelse(
        Ab42 < filter(cpAB142, subgroup == "ADNI")$optimal_cutpoint,
        str_c("<", signif(
          filter(cpAB142, subgroup == "ADNI")$optimal_cutpoint, 2
        )),
        str_c(">", signif(
          filter(cpAB142, subgroup == "ADNI")$optimal_cutpoint, 2
        ))
      ),
      ifelse(
        Ab42 < filter(cpAB142, subgroup == "IDOR")$optimal_cutpoint,
        str_c("<", signif(
          filter(cpAB142, subgroup == "IDOR")$optimal_cutpoint, 2
        )),
        str_c(">", signif(
          filter(cpAB142, subgroup == "IDOR")$optimal_cutpoint, 2
        ))
      )
    ),
    Tau = ifelse(
      Sample == "ADNI",
      ifelse(
        TAU > filter(cpTAU, subgroup == "ADNI")$optimal_cutpoint |
          TAU == filter(cpTAU, subgroup == "ADNI")$optimal_cutpoint,
        str_c(">=", signif(
          filter(cpTAU, subgroup == "ADNI")$optimal_cutpoint, 2
        )),
        str_c("<", signif(
          filter(cpTAU, subgroup == "ADNI")$optimal_cutpoint, 2
        ))
      ),
      ifelse(
        TAU > filter(cpTAU, subgroup == "IDOR")$optimal_cutpoint |
          TAU == filter(cpTAU, subgroup == "IDOR")$optimal_cutpoint,
        str_c(">=", signif(
          filter(cpTAU, subgroup == "IDOR")$optimal_cutpoint, 2
        )),
        str_c("<", signif(
          filter(cpTAU, subgroup == "IDOR")$optimal_cutpoint, 2
        ))
      )
    )
  )

CSF %>%
  group_by(Sample, Diagnostic, Ab, Tau) %>%
  summarise(N = n_distinct(SUBJ),
            age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2))) %>% kable(digits = 2) %>% kable_styling()

ggplot(CSF, aes(x = Ab, y = K, color = Sample)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means() +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(K ~ Ab * Sample, CSF))
TukeyHSD(aov(K ~ Ab * Sample, CSF))

ggplot(CSF, aes(x = Diagnostic, y = K, color = Ab)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

ggplot(CSF, aes(x = Ab42, y = K, color = Diagnostic)) +
  geom_point(aes(size = Age, shape = Sample), alpha = 0.4) +
  geom_hline(yintercept = cpK$optimal_cutpoint) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  geom_vline(data = cpAB142, aes(xintercept = optimal_cutpoint, linetype = subgroup)) +
  theme_pubr()

summary(aov(K ~ Ab * Diagnostic * Sample, CSF))
# TukeyHSD(aov(K ~ Ab*Diagnostic*Sample, CSF))

ggplot(CSF, aes(x = Tau, y = K, color = Sample)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means() +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(K ~ Tau * Sample, CSF))
TukeyHSD(aov(K ~ Tau * Sample, CSF))

ggplot(CSF, aes(x = Diagnostic, y = K, color = Tau)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

ggplot(CSF, aes(x = TAU, y = K, color = Diagnostic)) +
  geom_point(aes(size = Age, shape = Sample), alpha = 0.4) +
  geom_vline(data = cpTAU, aes(xintercept = optimal_cutpoint, linetype = subgroup)) +
  geom_hline(yintercept = cpK$optimal_cutpoint) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

summary(aov(K ~ Tau * Diagnostic * Sample, CSF))
# TukeyHSD(aov(K ~ Tau*Diagnostic*Sample, CSF))
```

## Harmonized
```{r}
ggplot(CSF, aes(x = Ab, y = K_shiftc, color = Sample)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means() +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(K_shiftc ~ Ab * Sample, CSF))
TukeyHSD(aov(K_shiftc ~ Ab * Sample, CSF))

ggplot(CSF, aes(x = Diagnostic, y = K_shiftc, color = Ab)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

ggplot(CSF, aes(x = Ab42, y = K_shiftc, color = Diagnostic)) +
  geom_point(aes(size = Age, shape = Sample), alpha = 0.4) +
  geom_hline(yintercept = cpK$optimal_cutpoint) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  geom_vline(data = cpAB142, aes(xintercept = optimal_cutpoint, linetype = subgroup)) +
  theme_pubr()

ggplot(filter(CSF, Sample == "ADNI"), aes(x = Ab42, y = K_shiftc, color = Diagnostic)) +
  geom_point(aes(size = Age, shape = Sample), alpha = 0.4) +
  geom_hline(yintercept = cpK$optimal_cutpoint) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  geom_vline(data = cpAB142, aes(xintercept = optimal_cutpoint, linetype = subgroup)) +
  theme_pubr()

summary(aov(K_shiftc ~ Ab * Diagnostic * Sample, CSF))
# TukeyHSD(aov(K_shiftc ~ Ab*Diagnostic*Sample, CSF))

ggplot(CSF, aes(x = Tau, y = K_shiftc, color = Sample)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  stat_compare_means() +
  guides(alpha = "none") +
  theme_pubr()

summary(aov(K_shiftc ~ Tau * Sample, CSF))
TukeyHSD(aov(K_shiftc ~ Tau * Sample, CSF))

ggplot(CSF, aes(x = Diagnostic, y = K_shiftc, color = Tau)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

ggplot(CSF, aes(x = TAU, y = K_shiftc, color = Diagnostic)) +
  geom_point(aes(size = Age), alpha = 0.4) +
  geom_vline(data = cpTAU, aes(xintercept = optimal_cutpoint, linetype = subgroup)) +
  geom_hline(yintercept = cpK$optimal_cutpoint) +
  guides(alpha = "none") +
  facet_grid(. ~ Sample) +
  theme_pubr()

summary(aov(K_shiftc ~ Tau * Diagnostic, CSF))
# TukeyHSD(aov(K_shiftc ~ Tau*Diagnostice, CSF))
```

