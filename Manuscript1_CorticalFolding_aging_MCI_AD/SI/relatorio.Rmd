---
title: "comparing methods and samples"
author: "Fernanda Hansen Pacheco de Moraes"
date: "28 de JULHO de 2020"
output:
  html_document:
    df_print: kable
    fig_caption: yes
    fig_width: 8
    number_sections: yes
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r preparo, message=FALSE, warning=FALSE, include=FALSE}
# PREPARO

# define a area de trabalho
setwd("C:/Users/ferna/Documents/idor/Gyrification/RRRRRR/comparing_samples/") # se no computador

# carrega os pacotes utilizados
source("01-call_packages.R")

# Chama funcoes caso necessário
source("02-funcoes.R")

# onde estao os arquivos de resultados:
path <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/long_tables/")

path_yujiangscript <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")

path_yujiangscript_newsurfaces <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/Wang_code_extraction/")
  
path_lobes <- str_c("C:/Users/ferna/Documents/idor/Gyrification/STATS/LobesScaling/")
 
path_sessions <- str_c("C:/Users/ferna/Documents/idor/Gyrification/Processamento_longitudinal/V6/data/")

# importa os resultados
source("03-import_files.R") # arquivos dos sujeitos

# organiza os arquivos
source("04-organiza.R")
# source("rotina_arquivos_neuroquant_comparisson.R")

dados_raw <- dados_idor

verificar_lGI_zero <- filter(dados_idor, localGI == 0 | is.na(localGI))
write.csv(verificar_lGI_zero, "verificar_lGI_zero.csv")

# retira os outros diagnosticos e deixa so quem tem machine definido
dados_all <- dados_idor %>% filter(
    Diagnostic == "CONTROLE" |
      Diagnostic == "CCL" |
      Diagnostic == "ALZ", !is.na(logAvgThickness), logExposedArea != 0 | !is.na(localGI) | TotalArea != 0, !is.infinite(logExposedArea), !is.na(Age),SUBJ != "SUBJ211", SUBJ != "SUBJ223",SUBJ != "SUBJ231",SUBJ != "SUBJ136",SUBJ != "SUBJ014",SUBJ != "SUBJ128",SUBJ != "SUBJ157") %>% 
  droplevels() %>% mutate(Sample = "IDOR")

#,"

dados_excluidos <- anti_join(dados_raw, dados_all)
write.csv(dados_excluidos, "dados_excluidos.csv")

dados <- dados_all
dados$Diagnostic <- revalue(dados$Diagnostic, c("CONTROLE"="CTL", "ALZ"="AD", "CCL" = "MCI"))


Age.cor = 25

# Prepara os dados para analise
source("05-analises_prep.R")

dados_datasetscomp$Diagnostic[dados_datasetscomp$Diagnostic == "CONTROLE"] <- "CTL"

dados_datasetscomp$Gender[dados_datasetscomp$Gender == "F"] <- "FEM"
dados_datasetscomp$Gender[dados_datasetscomp$Gender == "M"] <- "MASC"

dados_datasetscomp$Sample[dados_datasetscomp$Sample == "ADNIAD"] <- "ADNI"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "ADNIControl"] <- "ADNI"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "OASIS_healthy"] <- "OASIS"


dados_datasetscomp$machine[dados_datasetscomp$Sample == "HCP"] <- "Siemens-Skyra-modified-3T"
dados_datasetscomp$FieldStrenght[dados_datasetscomp$Sample == "HCP"] <- 3

dados_datasetscomp$machine[dados_datasetscomp$Sample == "NKI"] <- "Siemens-Magnetom-3T"
dados_datasetscomp$FieldStrenght[dados_datasetscomp$Sample == "NKI"] <- 3

dados_datasetscomp$machine[dados_datasetscomp$Sample == "OASIS"] <- "Siemens-Vision-1.5T"
dados_datasetscomp$FieldStrenght[dados_datasetscomp$Sample == "OASIS"] <- 1.5

dados_datasetscomp$machine[dados_datasetscomp$Sample == "ADNI"] <- "multiple-3T"
dados_datasetscomp$FieldStrenght[dados_datasetscomp$Sample == "ADNI"] <- 3


dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-ZK" &
                                  dados_datasetscomp$Diagnostic == "MICRO"] <- "IDOR-ZKMICRO"

write.csv(dados_datasetscomp,"dados_datasetscomp.csv")


dados_datasetscomp <- dados_datasetscomp %>% filter(!is.na(Diagnostic))
```

# Metodo

## Numero de sujeitos

### Todos da lista
```{r N sujeitos, echo=FALSE, message=FALSE, warning=FALSE}
filter(dados_datasetscomp,
       Sample != "Mota&Houzel2015",
       ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  summarise(
    N = n_distinct(SUBJ),
    age = paste(signif(mean(Age), 2), "±", signif(sd(Age), 2)),
    age_range = paste(signif(min(Age), 2), "; ", signif(max(Age), 2)),
    AvgT =  paste(signif(mean(AvgThickness), 2), "±", signif(sd(AvgThickness), 2)),
    AT =  paste(signif(mean(TotalArea), 2), "±", signif(sd(TotalArea), 2)),
    AE =  paste(signif(mean(ExposedArea), 2), "±", signif(sd(ExposedArea), 2)),
    K =  paste(signif(mean(K), 2), "±", signif(sd(K), 2)),
    S =  paste(signif(mean(S), 2), "±", signif(sd(S), 2)),
    I =  paste(signif(mean(I), 2), "±", signif(sd(I), 2))
  ) %>% kable(digits = 2) %>% kable_styling()


filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic, Gender) %>%
  summarise(
    N = n_distinct(SUBJ)
) %>% t() %>% kable(digits = 2) %>% kable_styling()
```


```{r N, echo=FALSE, message=FALSE, warning=FALSE}
N <-filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere") %>%
  group_by(Sample) %>%
  summarise(
    N = n_distinct(SUBJ)
)
N %>% t() %>% kable(digits = 2) %>% kable_styling()

paste("N total de sujeitos = ", sum(N$N))
```

# Distrubuição da Sample

```{r distribuicao da Sample}
ggplot(data = filter(dados_datasetscomp, ROI == "hemisphere"), aes(x = Diagnostic, y = Age, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) + 
  geom_boxplot() + theme_pubr() +
  stat_compare_means(method = "anova") + facet_wrap(Sample ~. ) + theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

ggplot(data = dados_datasetscomp, aes(x = Diagnostic, y = K, color = Gender, fill = Gender, alpha = 0.4)) + 
  geom_boxplot() + theme_pubr() +
  stat_compare_means(method = "anova") + facet_wrap(Sample ~. )+ theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

```

```{r eval=FALSE, include=FALSE}
# paste("SUBJs lobos:")
# dados_datasetscomp %>% filter(ROI == "F" | ROI == "T" | ROI == "O" | ROI == "P", Sample == "AOMIC"| Sample == "AHEAD"| Sample == "IDOR") %>% group_by(Sample, hemi, ROI) %>% summarise(SUBJ = unique(SUBJ)) %>% kable() %>% kable_styling()
# paste("SUBJs hemi:")
# dados_datasetscomp %>% filter(ROI == "hemisphere", Sample == "AOMIC"| Sample == "AHEAD"| Sample == "IDOR")  %>% group_by(Sample, hemi) %>% summarise(SUBJ = unique(SUBJ)) %>% kable() %>% kable_styling()

```

# Resultados

## Aplicacao do modelo

### Todos os dados, incluindo animais
```{r model Mota & Houzel, echo=FALSE}
dados_datasetscomp <- dados_datasetscomp %>% mutate(Family = "Hominidae", Species = "Homo sapiens")

dados_MH2015 <- mutate(dados_MH2015, ROI = "hemisphere", Diagnostic = "CTL")
dados_datasetscomp_MH <- full_join(dados_datasetscomp, dados_MH2015)

amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)

dados_datasetscomp_MH_2 <- filter(dados_datasetscomp_MH, ROI == "hemisphere")

ggplot(data = dados_datasetscomp_MH_2, aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) 
  
ggplot(data = dados_datasetscomp_MH_2, aes(I, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

ggplot(data = dados_datasetscomp_MH_2, aes(K, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  )

amostra_Coef %>% kable(digits = 2) %>% kable_styling()

amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere") %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)
amostra_Coef %>% kable(digits = 2) %>% kable_styling()

```

```{r}
amostras_Coef <- filter(dados_datasetscomp, Sample != "Mota&Houzel2015", ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  do(fit_amostras = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
unnest(fit_amostras) 
# amostras_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_Coef, term == "logExposedArea"),
  aes(
    x = reorder(Sample, estimate),
    y = estimate,
    color = Sample
  )
) +
  geom_point() + geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope", x = "Institution", caption = "Only healthy subjects")+ theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))
```

### lGI
```{r}

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample != "AHEAD", Sample != "HCP500r"), aes(Age, TotalArea/ExposedArea)) +
  geom_point(aes(color = Sample)) +
  geom_smooth( se = TRUE, color = "gray") +
  geom_smooth(method="lm", linetype = "dashed", se = TRUE, color = "black", alpha = 0.5) +
  stat_cor()+
  theme_pubr() + labs(caption = "Only healthy subjects")

ggplot(filter(dados_datasetscomp, ROI != "hemisphere", Diagnostic == "CTL", Sample != "AHEAD", Sample != "HCP500r"), aes(Age, TotalArea/ExposedArea)) +
  geom_point(aes(color = Sample)) +
  geom_smooth( se = TRUE, color = "gray") +
  geom_smooth(method="lm", linetype = "dashed", se = TRUE, color = "black", alpha = 0.5) +
  stat_cor()+
  theme_pubr() + facet_grid(ROI ~ .)+ labs(caption = "Only healthy subjects")
```

### K
```{r echo=FALSE}

ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample != "AHEAD", Sample != "HCP500r"), aes(Age, K)) +
  geom_point(aes(color = Sample)) +
  geom_smooth( se = TRUE, color = "gray") +
  geom_smooth(method="lm", linetype = "dashed", se = TRUE, color = "black", alpha = 0.5) +
  stat_cor()+
  theme_pubr()+ labs(caption = paste("Only healthy subjects, N=",n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample != "AHEAD", Sample != "HCP500r")$SUBJ)))

ggplot(filter(dados_datasetscomp, ROI != "hemisphere", Diagnostic == "CTL", Sample != "AHEAD", Sample != "HCP500r"), aes(Age, K)) +
  geom_point(aes(color = Sample)) +
  geom_smooth( se = TRUE, color = "gray") +
  geom_smooth(method="lm", linetype = "dashed", se = TRUE, color = "black", alpha = 0.5) +
  stat_cor()+
  theme_pubr() + facet_grid(ROI ~ .)+ labs(caption = "Only healthy subjects")+ theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

ggplot(data = dados_datasetscomp, aes(x = Sample, y = K, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) + 
  geom_boxplot() + theme_pubr() +
  stat_compare_means(method = "anova")
ggplot(data = dados_datasetscomp, aes(x = Sample, y = K_age_decay, color = Diagnostic, fill = Diagnostic, alpha = 0.4)) + 
  geom_boxplot() + theme_pubr() +
  stat_compare_means(method = "anova") + theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))
```

### Apenas humanos IDOR

```{r modelo_humanos, echo=FALSE, message=FALSE, warning=FALSE}

fit_comp_idor_Coef <- filter(dados_datasetscomp, ROI == "hemisphere") %>%
  group_by(Sample, Diagnostic) %>%
  do(fit_comp_idor = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE)) %>% 
unnest(fit_comp_idor) 

# fit_comp_idor_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere"),
  aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp$SUBJ)
  ))

paste("Verificando a diferenca entre o coeficiente obtido para a Sample e o teorico de 5/4, qual o valor p deste teste?", test_coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit), 2, 1.25))

```

#### SLOPE?

```{r slope, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(
  data = filter(fit_comp_idor_Coef, term == "logExposedArea"),
  aes(
  x = reorder(Sample, estimate),
  y = estimate,
  color = Sample
  )
  ) +
  geom_point() + geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "Slope", x = "Institution")

# Separa o grupo IDOR por diagnosticos

unique(dados_datasetscomp$Diagnostic)

dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR" &
                                  dados_datasetscomp$Diagnostic == "CTL"] <- "IDOR-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR" &
                                  dados_datasetscomp$Diagnostic == "AD"] <- "IDOR-AD"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR" &
                                  dados_datasetscomp$Diagnostic == "MCI"] <- "IDOR-MCI"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-subAgCC" &
                                  dados_datasetscomp$Diagnostic == "AgCC"] <- "IDOR-AgCC"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-subAgCC" &
                                  dados_datasetscomp$Diagnostic == "CTL"] <- "IDOR-AgCC-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-ZK" &
                                  dados_datasetscomp$Diagnostic == "ZK"] <- "IDOR-ZK"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-ZK" &
                                  dados_datasetscomp$Diagnostic == "CHIK"] <- "IDOR-CHIK"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-ZK" &
                                  dados_datasetscomp$Diagnostic == "PRES ZK"] <- "IDOR-PRESZK"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "IDOR-ZK" &
                                  dados_datasetscomp$Diagnostic == "OUTROS"] <- "IDOR-OUTROS"

dados_datasetscomp$Sample[dados_datasetscomp$Sample == "CALTECH" &
                                  dados_datasetscomp$Diagnostic == "CTL"] <- "CALTECH-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "CALTECH" &
                                  dados_datasetscomp$Diagnostic == "AgCC"] <- "CALTECH-AgCC"

dados_datasetscomp$Sample[dados_datasetscomp$Sample == "UCSF" &
                                  dados_datasetscomp$Diagnostic == "CTL"] <- "UCSF-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "UCSF" &
                                  dados_datasetscomp$Diagnostic == "AgCC"] <- "UCSF-AgCC"

dados_datasetscomp$Sample[dados_datasetscomp$Sample == "HCP500r"] <- "HCP500r-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "OASIS"] <- "OASIS-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "AOMIC"] <- "AOMIC-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "AHEAD"] <- "AHEAD-Control"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "AOMICPIOP2"] <- "AOMICPIOP2-Control"


dados_datasetscomp$Sample[dados_datasetscomp$Sample == "NKI"] <- "NKI-Control"


dados_datasetscomp$Sample[dados_datasetscomp$Sample == "ADNI" & dados_datasetscomp$Diagnostic == "AD"] <- "ADNI-AD"
dados_datasetscomp$Sample[dados_datasetscomp$Sample == "ADNI"& dados_datasetscomp$Diagnostic == "CTL"] <- "ADNI-Control"

ggplot(data = filter(dados_datasetscomp, ROI == "hemisphere"), aes(logExposedArea, 1/2*logAvgThickness + logTotalArea, color = Sample, fill = Sample, alpha)) +
  geom_point() +   geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea_age_decay ~ logExposedArea_age_decay, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr()

amostras_Coef <- filter(dados_datasetscomp, ROI == "hemisphere") %>%
  group_by(Sample) %>%
  do(fit_amostras = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE)) %>%
 unnest(fit_amostras) %>% filter(term == "logExposedArea")

amostras_Coef_age <- filter(dados_datasetscomp, ROI == "hemisphere") %>%
  group_by(Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    min_age = min(Age),
    max_age = max(Age))

amostras_Coef <- full_join(amostras_Coef, amostras_Coef_age)


figS3 <- ggplot(
  data = amostras_Coef,
  aes(
  x = reorder(Sample, estimate),
  y = estimate,
  )
  ) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
 theme_pubr() +
  labs(y = "Slope", x = "Sample \n N, (age range)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

figS3

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 

#ggsave("figS3.pdf", plot = figS3, dpi=1200, width = 16, height = 11, units = "cm", device = "pdf")
#ggsave("figS3.jpeg", plot = figS3, dpi=1200, width = 16, height = 11, units = "cm", device = "jpeg")


ggplot(
    data = amostras_Coef,
    aes(
        x = reorder(Sample, estimate),
        y = estimate,
    )
) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() +
    labs(y = "Slope", x = "Sample \n N, (age range)", caption= "Bars represent Confidence Interval at 95%") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

amostras_Coef_CTL <- filter(amostras_Coef, str_ends(Sample, "-Control")==TRUE)

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 


ggplot(
    data = amostras_Coef_CTL,
    aes(
        x = reorder(Sample, estimate),
        y = estimate,
    )
) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() +
    labs(y = "Slope", x = "Sample \n N, (age range)", caption= "Bars represent Confidence Interval at 95%") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 


amostras_age_Coef <-
  filter(
  dados_datasetscomp, ROI == "hemisphere"
  ) %>%
  group_by(Sample, Age_interval10) %>%
  do(
  fit_amostras_age = tidy(lm(
  1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea,
  data = .,
  na.action = na.omit
  ), conf.int =TRUE
  )) %>% unnest(fit_amostras_age)

# amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_age_Coef, term == "logExposedArea"),
  aes(x = Age_interval10,
  y = estimate,
  color = Sample)
  ) +
   geom_line(aes(group = Sample)) + geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope", x = "Age intervals in decades") 

amostras_age_Coef <-
  filter(
  dados_datasetscomp, ROI == "hemisphere"
  ) %>%
  group_by(Age_interval10) %>%
  do(
  fit_amostras_age = tidy(lm(
  1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea,
  data = .,
  na.action = na.omit
  ), conf.int =TRUE
  )) %>% unnest(fit_amostras_age)

# amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_age_Coef, term == "logExposedArea"),
  aes(x = Age_interval10,
  y = estimate)
  ) +
   geom_line(aes(group = 1)) + geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope", x = "Age intervals in decades") 

# amostras_age_Coef <-
#   filter(
#   dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"
#   ) %>%
#   group_by(Sample, Age) %>%
#   do(
#   fit_amostras_age = tidy(lm(
#   1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea,
#   data = .,
#   na.action = na.omit
#   ), conf.int =TRUE
#   )) %>% unnest(fit_amostras_age)
# 
# # amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()
# 
# ggplot(
#   data = filter(amostras_age_Coef, term == "logExposedArea"),
#   aes(x = Age,
#       y = estimate, color = Sample)
# ) + geom_point() + geom_smooth(method = "lm", color = "black")+ 
#   geom_errorbar(aes(ymin = conf.low, ymax = conf.high, color = Sample)) +
#   geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope", x = "Age intervals in decades") + ylim (0, 5)

```



```{r}

amostras_Coef_CTL <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample) %>%
  do(fit_amostras = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>%
  unnest(fit_amostras)

Age_Coef_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample, Age_interval10) %>%
  do(fit_Age_diag = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>%
  unnest(fit_Age_diag)

# Age_Coef_diag

N_subj_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL") %>%
  group_by(Sample, Age_interval10) %>%
  summarise(N_SUBJ = n_distinct(SUBJ))

ggplot(
  data = filter(Age_Coef_diag, term == "logExposedArea"),
  aes(
  x = Age_interval10,
  y = estimate, color = Sample, fill = Sample
  )
  ) +
  geom_point() +
  geom_line(aes(group = Sample)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_hline(data = filter(amostras_Coef_CTL, term == "logExposedArea"), aes(yintercept = estimate, color = Sample)) + 
  geom_text(aes(label = N_subj_diag$N_SUBJ), nudge_y = 0.6) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() +
  facet_grid(Sample ~.) + 
  labs(y = "slope", x = "Age intervals in decades", caption = "Only healthy subjects")
```

### DEAGING
#### Apenas humanos IDOR

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# fit_comp_idor_Coef <- filter(dados_datasetscomp, ROI == "hemisphere") %>%
#   group_by(Sample, Diagnostic) %>%
#   do(fit_comp_idor = tidy(lm(1/2 * logAvgThickness + logTotalArea_age_decay ~ logExposedArea_age_decay, data = ., na.action = na.omit), conf.int = TRUE)) %>% 
# unnest(fit_comp_idor) 

# fit_comp_idor_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere"),
  aes(logExposedArea_age_decay, 1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") + 
  theme_pubr() +
  labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(dados_datasetscomp$SUBJ)
  ))

paste("Verificando a diferenca entre o coeficiente obtido para a Sample e o teorico de 5/4, qual o valor p deste teste?", test_coef(lm(1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay, data = filter(dados_datasetscomp, ROI == "hemisphere"), na.action = na.omit), 2, 1.25))


```

#### SLOPE?

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Separa o grupo IDOR por diagnosticos

amostras_Coef <- filter(dados_datasetscomp, ROI == "hemisphere") %>%
  group_by(Sample) %>%
  do(fit_amostras = tidy(lm(1/2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay, data = ., na.action = na.omit), conf.int = TRUE)) %>%
 unnest(fit_amostras) %>% filter(term == "logExposedArea_age_decay")

amostras_Coef_age <- filter(dados_datasetscomp, ROI == "hemisphere", Sample != "IDOR-MICRO") %>%
  group_by(Sample) %>%
  summarise(
    N = n_distinct(SUBJ),
    min_age = min(Age),
    max_age = max(Age))

amostras_Coef <- full_join(amostras_Coef, amostras_Coef_age)


figS3 <- ggplot(
  data = amostras_Coef,
  aes(
  x = reorder(Sample, estimate),
  y = estimate,
  )
  ) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
 theme_pubr() +
  labs(y = "Slope - deaged", x = "Sample \n N, (age range)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

figS3

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 

#ggsave("figS3.pdf", plot = figS3, dpi=1200, width = 16, height = 11, units = "cm", device = "pdf")
#ggsave("figS3.jpeg", plot = figS3, dpi=1200, width = 16, height = 11, units = "cm", device = "jpeg")


ggplot(
    data = amostras_Coef,
    aes(
        x = reorder(Sample, estimate),
        y = estimate,
    )
) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() +
    labs(y = "Slope - deaged", x = "Sample \n N, (age range)", caption= "Bars represent Confidence Interval at 95%") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

amostras_Coef_CTL <- filter(amostras_Coef, str_ends(Sample, "-Control")==TRUE)

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 


ggplot(
    data = amostras_Coef_CTL,
    aes(
        x = reorder(Sample, estimate),
        y = estimate,
    )
) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    geom_hline(yintercept = 1.25, linetype = "dashed") +
    theme_pubr() +
    labs(y = "Slope - deaged", x = "Sample \n N, (age range)", caption= "Bars represent Confidence Interval at 95%") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9))

#scale_x_discrete(labels = paste(amostras_Coef$Sample,"\n",amostras_Coef$N,", (",signif(amostras_Coef$min_age,2),"-",signif(amostras_Coef$max_age,2),")")) + 


amostras_age_Coef <-
  filter(
  dados_datasetscomp, ROI == "hemisphere"
  ) %>%
  group_by(Sample, Age_interval10) %>%
  do(
  fit_amostras_age = tidy(lm(
  1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay,
  data = .,
  na.action = na.omit
  ), conf.int =TRUE
  )) %>% unnest(fit_amostras_age)

# amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_age_Coef, term == "logExposedArea_age_decay"),
  aes(x = Age_interval10,
  y = estimate,
  color = Sample)
  ) +
   geom_line(aes(group = Sample)) + geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope - deaged", x = "Age intervals in decades") 

amostras_age_Coef <-
  filter(
  dados_datasetscomp, ROI == "hemisphere"
  ) %>%
  group_by(Age_interval10) %>%
  do(
  fit_amostras_age = tidy(lm(
  1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay,
  data = .,
  na.action = na.omit
  ), conf.int =TRUE
  )) %>% unnest(fit_amostras_age)

# amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_age_Coef, term == "logExposedArea_age_decay"),
  aes(x = Age_interval10,
  y = estimate)
  ) +
   geom_line(aes(group = 1)) + geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope - deaged", x = "Age intervals in decades") 

amostras_age_Coef <-
  filter(
  dados_datasetscomp, ROI == "hemisphere"
  ) %>%
  group_by(SUBJ, Age, Sample) %>%
  do(
  fit_amostras_age = tidy(lm(
  1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay,
  data = .,
  na.action = na.omit
  ), conf.int =TRUE
  )) %>% unnest(fit_amostras_age)

# amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()

ggplot(
  data = filter(amostras_age_Coef, term == "logExposedArea_age_decay"),
  aes(x = Age,
  y = estimate, color = Sample)
  ) +
   geom_line(aes(group = 1)) +
  #geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope - deaged", x = "Age intervals in decades") 

# amostras_age_Coef <-
#   filter(
#   dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"
#   ) %>%
#   group_by(Sample, Age) %>%
#   do(
#   fit_amostras_age = tidy(lm(
#   1 / 2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay,
#   data = .,
#   na.action = na.omit
#   ), conf.int =TRUE
#   )) %>% unnest(fit_amostras_age)
# 
# # amostras_age_Coef %>% kable(digits = 4) %>% kable_styling()
# 
# ggplot(
#   data = filter(amostras_age_Coef, term == "logExposedArea_age_decay"),
#   aes(x = Age,
#       y = estimate)
# ) + geom_point(aes(color = Sample)) + geom_smooth(method = "lm", color = "black") +
#   geom_errorbar(aes(ymin = conf.low, ymax = conf.high, color = Sample)) +
#   geom_hline(yintercept = 1.25, linetype = "dashed") + theme_pubr() + labs(y = "slope-deaged", x = "Age intervals in decades") + ylim (0, 5)
```


## Mapping

### CTL
```{r mapping}
#, Diagnostic == "CTL"

figS6a <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = K)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
figS6a

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$K, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

figS6b <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = S)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) + geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")
figS6b

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$S, filter(dados_datasetscomp, ROI == "hemisphere",  Diagnostic == "CTL")$Age)

figS6c <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL"),
       aes(x = Age, y = I)) + geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) + geom_smooth(color = "black", linetype = 2) + geom_smooth(color = "black", method = "lm") + theme_pubr() +
  guides(alpha = FALSE, color = FALSE,fill = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")
 figS6c      

figS6 <- ggarrange(figS6a, ggarrange(figS6b, figS6c,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ggsave("figS6.pdf", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "pdf")
ggsave("figS6.jpeg", plot = figS6, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$I, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL")$Age)

mean_K_I_S <-
  filter(dados_datasetscomp, ROI == "hemisphere") %>% group_by(Sample, Diagnostic) %>% summarise(
    mean.K = mean(K, na.rm = TRUE),
    SD_K = sd(K, na.rm = TRUE),
    mean.I = mean(I, na.rm = TRUE),
    SD_I = sd(I, na.rm = TRUE),
    mean.S = mean(S, na.rm = TRUE),
    SD_S = sd(S, na.rm = TRUE)
    )

plot_ly(
  filter(dados_datasetscomp, ROI == "hemisphere"),
  x = ~ K,
  z =  ~ S,
  y =  ~ I,
  color = ~ Sample,
  type = "scatter3d",
  mode = 'markers'
) %>% layout(scene = list(
  
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))

plot_ly(
  filter(dados_datasetscomp, ROI == "hemisphere"),
  x = ~ K,
  y =  ~ S,
  color = ~ Sample,
  type = "scatter",
  mode = 'markers'
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  yaxis = list(title = 'S', scaleanchor = "x"))
)

ggplot(filter(dados_datasetscomp, ROI == "hemisphere"), aes(K, S, color = Sample)) + geom_point() + stat_ellipse() + theme_pubr()


plot_ly(
mean_K_I_S,
  x = ~ mean.K,
  z =  ~ mean.S,
  y =  ~ mean.I,
  color = ~ Sample,
text =  ~ Sample,
  type = "scatter3d",
  mode = 'markers+text', showlegend = FALSE
) %>% layout(scene = list(
  xaxis = list(title = 'K'),
  zaxis = list(title = 'S', scaleanchor = "x"),
  yaxis = list(title = 'I', scaleanchor = "x")
))
```

### Decreasing rate
#### K

```{r}
#dados_datasetscomp <- filter(dados_datasetscomp)
#, Sample = "IDOR-Control_young"
dados_datasetscomp_rate <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL" | Diagnostic == "MCI"| Diagnostic == "AD", Sample != "IDOR-AgCC-Control")
dados_datasetscomp_rate$Diagnostic <- factor(dados_datasetscomp_rate$Diagnostic, levels = c("CTL", "MCI","AD"))
#dados_datasetscomp$Diagnostic <- relevel(dados_datasetscomp$Diagnostic, ref = "CTL")

m.interaction <- lm(K ~ Age*Diagnostic, data = dados_datasetscomp_rate, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
glance <- glance(m.interaction)

tidy <- tidy(m.interaction)
tidy %>% kable() %>% kable_styling()

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidy, str_starts(term, "Age") )$p.value
  )
m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Constrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_K_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "K", shape = "Diagnostic")+ 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

m.lst.comp <- m.lst %>% mutate(Samples = "MA", variable = "K")

a.K = tidy$estimate[tidy$term == "Age"]
b.K = tidy$estimate[tidy$term == "(Intercept)"]
a.K.se = tidy$std.error[tidy$term == "Age"]
b.K.se = tidy$std.error[tidy$term == "(Intercept)"]

lm.K.se = glance$sigma

a.K
b.K
lm.K.se
```

#### S

```{r}
m.interaction <- lm(S ~ Age*Diagnostic, data = dados_datasetscomp_rate, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
glance <- glance(m.interaction)

tidy <- tidy(m.interaction) 
tidy %>% kable() %>% kable_styling()

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidy, str_starts(term, "Age") )$p.value
  )
m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()

fig_TX_S_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
  geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'),x = "Constrast") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_S_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "S", shape = "Diagnostic") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

m.lst <- m.lst %>% mutate(Samples = "MA", variable = "S")
m.lst.comp <- rbind(m.lst.comp, m.lst)

a.S = tidy$estimate[tidy$term == "Age"]
b.S = tidy$estimate[tidy$term == "(Intercept)"]
a.S.se = tidy$std.error[tidy$term == "Age"]
b.S.se = tidy$std.error[tidy$term == "(Intercept)"]

lm.S.se = glance$sigma

```


#### I

```{r}
m.interaction <- lm(I ~ Age*Diagnostic, data = dados_datasetscomp_rate, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
glance <- glance(m.interaction)

tidy <- tidy(m.interaction) 
tidy %>% kable() %>% kable_styling()


# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidy, str_starts(term, "Age") )$p.value
  )
m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()

fig_TX_I_age <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
  geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Constrast") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_I_age <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "I", shape = "Diagnostic") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

m.lst <- m.lst %>% mutate(Samples = "MA", variable = "I")
m.lst.comp <- rbind(m.lst.comp, m.lst)

a.I = tidy$estimate[tidy$term == "Age"]
b.I = tidy$estimate[tidy$term == "(Intercept)"]
a.I.se = tidy$std.error[tidy$term == "Age"]
b.I.se = tidy$std.error[tidy$term == "(Intercept)"]

lm.I.se = glance$sigma

```

```{r}
fig_TX_age <- ggarrange(fig_TX_K_age, ggarrange(fig_TX_S_age, fig_TX_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age

ggsave("fig_TX_age.pdf", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age.jpeg", plot = fig_TX_age, dpi=1200, width = 18, height = 18, units = "cm", device = "jpeg")

fig_age <- ggarrange(fig_K_age, ggarrange(fig_S_age, fig_I_age,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_age

ggsave("fig_age.pdf", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_age.jpeg", plot = fig_age, dpi=1200, width = 18, height = 18, units = "cm", device = "jpeg")
```

#### IDOR

```{r echo=FALSE}

figS6a_idor <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control"),
       aes(x = Age, y = K)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$K, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$Age)

figS6b_idor <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control"),
       aes(x = Age, y = S)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$S, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$Age)

figS6c_idor <- ggplot(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control"),
       aes(x = Age, y = I)) +
  geom_point(aes(color = Sample, fill = Sample, alpha = 0.4)) +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

cor.test(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$I, filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "IDOR-Control")$Age)

figS6_idor <- ggarrange(figS6a_idor, ggarrange(figS6b_idor, figS6c_idor,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ggsave("figS6_idor.pdf", plot = figS6_idor, dpi=1200, width = 18, height = 22, units = "cm", device = "pdf")
ggsave("figS6_idor.jpeg", plot = figS6_idor, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")

```


### Decreasing rate
#### K

```{r}
dados_datasetscomp_IDOR <- filter(dados_datasetscomp, ROI == "hemisphere", Sample == "IDOR-Control" | Sample == "IDOR-AD" | Sample == "IDOR-MCI")
dados_datasetscomp_IDOR$Diagnostic <- factor(dados_datasetscomp_IDOR$Diagnostic, levels = c("CTL", "MCI","AD")) #dados_datasetscomp$Diagnostic <- relevel(dados_datasetscomp$Diagnostic, ref = "CTL")

m.interaction <- lm(K ~ Age*Diagnostic, data = dados_datasetscomp_IDOR, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
tidyi <- tidy(m.interaction)
tidyi %>% kable() %>% kable_styling()

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidyi, str_starts(term, "Age") )$p.value
  )
m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()
 
fig_TX_K_age_idor <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
   geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'K/'*Delta*'Age)'), x = "Constrast") +
  theme_pubr() + 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_K_age_idor <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "K", shape = "Diagnostic")+ 
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

m.lst <- m.lst %>% mutate(Samples = "IDOR", variable = "K")
m.lst.comp <- rbind(m.lst.comp, m.lst)
```


#### S

```{r}
m.interaction <- lm(S ~ Age*Diagnostic, data = dados_datasetscomp_IDOR, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
tidyi <- tidy(m.interaction)
tidyi %>% kable() %>% kable_styling()

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidyi, str_starts(term, "Age") )$p.value
  )
m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()

fig_TX_S_age_idor <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
  geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) + ylim(-0.012, 0.012) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'S/'*Delta*'Age)'),x = "Constrast") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_S_age_idor <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "S", shape = "Diagnostic") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

m.lst <- m.lst %>% mutate(Samples = "IDOR", variable = "S")
m.lst.comp <- rbind(m.lst.comp, m.lst)
```


#### I
```{r}
m.interaction <- lm(I ~ Age*Diagnostic, data = dados_datasetscomp_IDOR, na.action = na.omit)
anova(m.interaction)
summary(m.interaction)

glance(m.interaction)
tidyi <- tidy(m.interaction)
tidyi %>% kable() %>% kable_styling()

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "Diagnostic", var="Age")
pairs <- pairs(m.lst)

m.lst <-
  as_tibble(m.lst) %>% mutate(
    TX = paste(signif(Age.trend, 2), "±", signif(SE, 2)),
    CI = paste(signif(lower.CL , 2), ";", signif(upper.CL , 2)),
    pvalue = filter(tidyi, str_starts(term, "Age") )$p.value
  )

m.lst %>% kable() %>% kable_styling()

pairs %>% kable() %>% kable_styling()

fig_TX_I_age_idor <- ggplot(data = as_tibble(pairs), aes(
    x = contrast,
    y = estimate,
    ymin = estimate - SE,
    ymax = estimate + SE)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
  geom_text(aes(label = str_c("p adj = ", signif(p.value, digits = 2))), nudge_x = 0.3) +
    coord_flip() + 
    labs(y =  expression('Differences in slopes ('*Delta*'I/'*Delta*'Age)'), x = "Constrast") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

e <- allEffects(m.interaction)
e <- as.data.frame(e[[1]])

fig_I_age_idor <- ggplot(e, aes(x = Age, y = fit,ymin=lower,ymax=upper, shape = Diagnostic)) + geom_pointrange() + geom_line() + theme_pubr() + labs(y = "I", shape = "Diagnostic") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")

m.lst <- m.lst %>% mutate(Samples = "IDOR", variable = "I")
m.lst.comp <- rbind(m.lst.comp, m.lst)
```

```{r}
fig_TX_age_idor <- ggarrange(fig_TX_K_age_idor, ggarrange(fig_TX_S_age_idor, fig_TX_I_age_idor,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_TX_age_idor

ggsave("fig_TX_age_idor.pdf", plot = fig_TX_age_idor, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_TX_age_idor.jpeg", plot = fig_TX_age_idor, dpi=1200, width = 18, height = 18, units = "cm", device = "jpeg")

fig_age_idor <- ggarrange(fig_K_age_idor, ggarrange(fig_S_age_idor, fig_I_age_idor,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig_age_idor

ggsave("fig_age_idor.pdf", plot = fig_age_idor, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig_age_idor.jpeg", plot = fig_age_idor, dpi=1200, width = 18, height = 18, units = "cm", device = "jpeg")
```
```{r}

m.lst.comp$variable <- factor(m.lst.comp$variable, c("K", "S", "I"))
m.lst.comp <- m.lst.comp %>% mutate(Signif = as.factor(ifelse(pvalue < 0.05 | pvalue == 0.05, "yes", "no")))

cols3 = gg_color_hue(length(levels(m.lst.comp$Signif)))
cols3[levels(m.lst.comp$Signif)=="yes"]="black"
cols3[levels(m.lst.comp$Signif)=="no"]="red"

fig.m.lst.comp.K <- ggplot(data = filter(m.lst.comp, variable == "K"), aes(
    x = Diagnostic,
    y = Age.trend,
    ymin = lower.CL,
    ymax = upper.CL, shape = Samples, color = Signif)) +
    geom_hline(yintercept = 0,
               linetype = "longdash",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
 # geom_text(aes(label = str_c("p adj = ", signif(pvalue, digits = 2))), nudge_x = 0.3) +
    labs(y =  "Age trend K", x = "Diagnostic") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))  +
  scale_color_manual(values = cols3)

fig.m.lst.comp.S <- ggplot(data = filter(m.lst.comp, variable == "S"), aes(
    x = Diagnostic,
    y = Age.trend,
    ymin = lower.CL,
    ymax = upper.CL, shape = Samples, color = Signif)) +
    geom_hline(yintercept = 0,
               linetype = "longdash",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
 # geom_text(aes(label = str_c("p adj = ", signif(pvalue, digits = 2))), nudge_x = 0.3) +
    labs(y =  "Age trend S", x = "Diagnostic") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none")  +
  scale_color_manual(values = cols3)

fig.m.lst.comp.I <- ggplot(data = filter(m.lst.comp, variable == "I"), aes(
    x = Diagnostic,
    y = Age.trend,
    ymin = lower.CL,
    ymax = upper.CL,
    shape = Samples, color = Signif)) +
    geom_hline(yintercept = 0,
               linetype = "longdash",
               colour = "grey60") +
    geom_pointrange( position = position_dodge(width = 0.2)) +
  #geom_text(aes(label = str_c("p adj = ", signif(pvalue, digits = 2))), nudge_x = 0.3) +
    labs(y =  "Age trend I", x = "Diagnostic") +
  theme_pubr() +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position= "none") +
  scale_color_manual(values = cols3)

fig.m.lst.comp <- ggarrange(fig.m.lst.comp.K, ggarrange(fig.m.lst.comp.S, fig.m.lst.comp.I,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

fig.m.lst.comp

ggsave("fig.m.lst.comp.pdf", plot = fig.m.lst.comp, dpi=1200, width = 18, height = 18, units = "cm", device = "pdf")
ggsave("fig.m.lst.comp.jpeg", plot = fig.m.lst.comp, dpi=1200, width = 18, height = 18, units = "cm", device = "jpeg")
```


##AOMIC-Control
```{r}
Age_Coef_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45") %>%
  group_by(Sample, Age_interval) %>%
  do(fit_Age_diag = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>%
  unnest(fit_Age_diag)

# Age_Coef_diag

N_subj_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45") %>%
  group_by(Sample, Age_interval) %>%
  summarise(N_SUBJ = n_distinct(SUBJ))

figS4a <- ggplot(
  data = filter(Age_Coef_diag, term == "logExposedArea", Age_interval != "80-85", Age_interval != "40-45"),
  aes(
  x = Age_interval ,
  y = estimate, color = Sample, fill = Sample
  )
  ) +
  geom_point() +
  geom_line(aes(group = Sample)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_hline(data = filter(amostras_Coef_CTL, term == "logExposedArea", Sample == "AOMIC-Control" | Sample == "IDOR-Control"), aes(yintercept = estimate, color = Sample)) + 
  geom_text(aes(label = N_subj_diag$N_SUBJ), nudge_y = 0.5) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() +
  labs(y = "slope", x = "Age [years]")  +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))
# + labs(caption = paste("N = ", n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control")$SUBJ)))

figS4a

ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"),
  aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control")$SUBJ)
  ))

ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"),
  aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI")$SUBJ)
  ))


aov_thick <- aov(AvgThickness ~ Sample, data = filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"))
summary(aov_thick)
#TukeyHSD(aov_thick)

ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control"
  ),
  aes(
    x = Sample,
    y = logAvgThickness,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(caption = paste(
    "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
    n_distinct(
      filter(
        dados_datasetscomp,
        ROI == "hemisphere",
        Sample == "AOMIC-Control" | Sample == "IDOR-Control"
      )$SUBJ
    )
  ))

figS4b <-ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45"
  ),
  aes(
    x = Age_interval ,
    y = logAvgThickness,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() +
  labs(x = "Age [years]", y = expression("log"[10]*"CorticalThickness [mm]")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

figS4b

aov_thick <- aov(AvgThickness ~ Sample*Age_interval10, data = filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85"))
summary(aov_thick)
#TukeyHSD(aov_thick)


aov_thick <- aov(AvgThickness ~ Sample, data = filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"))
summary(aov_thick)
#TukeyHSD(aov_thick)

ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI" 
  ),
  aes(
    x = Sample,
    y = logAvgThickness,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(caption = paste(
    "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
    n_distinct(
      filter(
        dados_datasetscomp,
        ROI == "hemisphere",
        Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
      )$SUBJ
    )
  ))

ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
  ),
  aes(
    x = Age_interval ,
    y = logAvgThickness,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(caption = paste(
    "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
    n_distinct(
      filter(
        dados_datasetscomp,
        ROI == "hemisphere",
        Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI" 
      )$SUBJ
    )
  ), x = "Age intervals of 5 years")

aov_thick <- aov(AvgThickness ~ Sample*Age_interval10, data = filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"))
summary(aov_thick)
#TukeyHSD(aov_thick)

ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
  ),
  aes(
    x = Age_interval ,
    y = logTotalArea,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(caption = paste(
    "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
    n_distinct(
      filter(
        dados_datasetscomp,
        ROI == "hemisphere",
        Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
      )$SUBJ
    )
  ), x = "Age intervals of 5 years")

ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
  ),
  aes(
    x = Age_interval ,
    y = logExposedArea,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(caption = paste(
    "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
    n_distinct(
      filter(
        dados_datasetscomp,
        ROI == "hemisphere",
        Sample == "AOMIC-Control" | Sample == "IDOR-Control"| Sample == "IDOR-AD" | Sample == "IDOR-MCI"
      )$SUBJ
    )
  ), x = "Age intervals of 5 years")

figS4c <- ggplot(
  filter(
    dados_datasetscomp,
    ROI == "hemisphere",
    Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45"
  ),
  aes(
    x = Age_interval ,
    y = K,
    color = Sample,
    fill = Sample, alpha = 0.5
  )
) +
  geom_boxplot() +
  theme_pubr() + labs(x = "Age [years]") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

figS4c

figS4 <- ggarrange(figS4a, figS4b, figS4c, labels = c("A","B", "C"), nrow = 1, ncol = 3, font.label = list(size = 11), common.legend = TRUE, legend = "top")

#ggsave("figS4.pdf", dpi=1200, width = 18, height = 9, units = "cm", device = "pdf")
#ggsave("figS4.jpeg", dpi=1200, width = 18, height = 9, units = "cm", device = "jpeg")


ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control"), aes(Age, K, color = Sample, fill = Sample)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control" )$SUBJ)
  ))

ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control")) +
  geom_smooth(aes(Age, K),method = "lm", se = TRUE) +
  geom_point(aes(Age, K, color = Sample, fill = Sample)) +
  geom_smooth(aes(Age, K, color = Sample, fill = Sample), method = "lm", se = TRUE) +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control" )$SUBJ)
  ))

```

```{r}
Age_Coef_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45") %>%
  group_by(Sample, Age_interval) %>%
  do(fit_Age_diag = tidy(lm(1/2 * logAvgThickness_age_decay + logTotalArea_age_decay ~ logExposedArea_age_decay, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>%
  unnest(fit_Age_diag)

# Age_Coef_diag

N_subj_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control", Age_interval != "80-85", Age_interval != "40-45") %>%
  group_by(Sample, Age_interval) %>%
  summarise(N_SUBJ = n_distinct(SUBJ))

figS4a2 <- ggplot(
  data = filter(Age_Coef_diag, term == "logExposedArea_age_decay", Age_interval != "80-85", Age_interval != "40-45"),
  aes(
  x = Age_interval ,
  y = estimate, color = Sample, fill = Sample
  )
  ) +
  geom_point() +
  geom_line(aes(group = Sample)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_hline(data = filter(amostras_Coef_CTL, term == "logExposedArea", Sample == "AOMIC-Control" | Sample == "IDOR-Control"), aes(yintercept = estimate, color = Sample)) + 
  geom_text(aes(label = N_subj_diag$N_SUBJ), nudge_y = 0.5) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() +
  labs(y = "slope -deaged", x = "Age [years]")  +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))
# + labs(caption = paste("N = ", n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Diagnostic == "CTL", Sample == "AOMIC-Control" | Sample == "IDOR-Control")$SUBJ)))

figS4a2
```


##AHEAD-Control
```{r}
# dados_datasetscomp <- filter(dados_datasetscomp, Sample != "AHEAD-Control") %>% mutate(AHEAD_age_interval = )

Age_Coef_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AHEAD-Control") %>%
  group_by(Age_interval) %>%
  do(fit_Age_diag = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE)) %>% unnest(fit_Age_diag)

Age_Coef_diag

N_subj_diag <- filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AHEAD-Control") %>%
  group_by(Age_interval) %>%
  summarise(N_SUBJ = n_distinct(SUBJ))

figS5 <- ggplot(
  data = filter(Age_Coef_diag, term == "logExposedArea"),
  aes(
  x = Age_interval ,
  y = estimate
  )
  ) +
  geom_point() +
  geom_line(aes(group = 1)) +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) +
  geom_text(aes(label = N_subj_diag$N_SUBJ), nudge_y = 0.17) +
  geom_hline(yintercept = 1.25, linetype = "dashed") +
  theme_pubr() +
  labs(y = "Slope", x = "Age [years]") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

figS5

#ggsave("figS5.pdf", dpi=1200, width = 11, height = 11, units = "cm", device = "pdf")
#ggsave("figS5.jpeg", dpi=1200, width = 11, height = 11, units = "cm", device = "jpeg")


ggplot(
  filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control" | Sample == "AHEAD-Control"),
  aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea, color = Sample, fill = Sample)
  ) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_abline(slope = 1.25, intercept = coef(lm(1 / 2 * logAvgThickness + logTotalArea ~ logExposedArea, data = dados_datasetscomp, na.action = na.omit))[1], color = "black") +
  theme_pubr() + labs(caption = paste(
  "Humanos de todos os diagnosticos, apenas 1 visita, N = ",
  n_distinct(filter(dados_datasetscomp, ROI == "hemisphere", Sample == "AOMIC-Control" | Sample == "IDOR-Control")$SUBJ)
  ))

```

## Simulating healthy values
```{r echo=FALSE}
Age <- as_tibble(runif(1000, min=0, max=100))
colnames(Age)[1] <- "Age"
paste("mean age from the random sample = ",signif(mean(Age$Age),2),"±",signif(sd(Age$Age),2))

pred <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = sqrt((abs(Age) * a.K.se) ^ 2 + b.K.se ^2),
  S = a.S * Age + b.S,
  S.se = sqrt((abs(Age) * a.S.se) ^ 2 + b.S.se ^2),
  I = a.I * Age + b.I,
  I.se = sqrt((abs(Age) * a.I.se) ^ 2 + b.I.se ^2),
  Diagnostic = "CTL-pred",
  ROI = "hemisphere"
)

paste("a.K = ", signif(a.K,2), ", b.K = ", signif(b.K,2), ", a.K.se = ", signif(a.K.se,2), ", b.K.se = ", signif(b.K.se,2))

paste("a.S = ", signif(a.S,2), ", b.S = ", signif(b.S,2), ", a.S.se = ", signif(a.S.se,2), ", b.S.se = ", signif(b.S.se,2))

paste("a.I = ", signif(a.I,2), ", b.I = ", signif(b.I,2), ", a.I.se = ", signif(a.I.se,2), ", b.I.se = ", signif(b.I.se,2))

# hist(pred$Age)
# hist(pred$K)
# hist(pred$S)
# hist(pred$I)

predictions <- ggplot(pred,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

predictions.S <- ggplot(pred,
       aes(x = Age, y = S, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted S") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

predictions.I <- ggplot(pred,
       aes(x = Age, y = I, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted I") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

```
#### Residual standard error
```{r}
pred.rse <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = lm.K.se,
  S = a.S * Age + b.S,
  S.se = lm.S.se,
  I = a.I * Age + b.I,
  I.se = lm.I.se,
  Diagnostic = "CTL-pred.rse",
  ROI = "hemisphere"
)

paste("a.K = ", signif(a.K,2), ", b.K = ", signif(b.K,2), ", lm.K.se = ", signif(lm.K.se,2))

paste("a.S = ", signif(a.S,2), ", b.S = ", signif(b.S,2), ", lm.S.se = ", signif(lm.S.se,2))

paste("a.I = ", signif(a.I,2), ", b.I = ", signif(b.I,2), ", lm.I.se = ", signif(lm.I.se,2))

# hist(pred$Age)
# hist(pred$K)
# hist(pred$S)
# hist(pred$I)

predictions.rse <- ggplot(pred.rse,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted K (RSE)") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

predictions.S.rse <- ggplot(pred.rse,
       aes(x = Age, y = S, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted S (RSE)") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

predictions.I.rse <- ggplot(pred.rse,
       aes(x = Age, y = I, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Predicted I (RSE)") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))
```


#### Simulating values with baeysian approach values

```{r echo=FALSE}
a.K = -0.00087 # extraído do modelo do Victor
b.K = -0.47 # extraído do modelo do Victor
K.se = 0.02

a.S = -0.000825 # extraído do modelo do Victor
b.S = 10.645 # extraído do modelo do Victor
S.se = .087

a.I = -0.001925 # extraído do modelo do Victor
b.I = 9.827 # extraído do modelo do Victor
I.se = 0.07

simulation <- Age %>% mutate(
  Age = Age,
  K = a.K * Age + b.K,
  K.se = 0.02,
  S = a.S * Age + b.S,
  S.se = 0.087, # Confirmar
  I = a.I * Age + b.I,
  I.se = 0.07, # Confirmar
  Diagnostic = "CTL-simulated",
  ROI = "hemisphere"
)

data <- full_join(pred, simulation)

simulationfig <- ggplot(simulation,
       aes(x = Age, y = K, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = K - K.se, ymax = K + K.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Simulated K") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

simulationfig.S <- ggplot(simulation,
       aes(x = Age, y = S, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = S - S.se, ymax = S + S.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Simulated S") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

simulationfig.I <- ggplot(simulation,
       aes(x = Age, y = I, alpha = 0.4)) +
  geom_point() +
  geom_errorbar(aes(ymin = I - I.se, ymax = I + I.se), color = "gray") +
  geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]", y = "Simulated I ") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

# healthyvalues <- ggarrange(predictions, simulationfig, predictions.S, simulationfig.S, predictions.I, simulationfig.I, nrow = 3, ncol = 2, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 11))

#healthyvalues

healthyvalues2 <- ggarrange(predictions, predictions.rse, simulationfig, predictions.S, predictions.S.rse, simulationfig.S, predictions.I, predictions.I.rse, simulationfig.I, nrow = 3, ncol = 3, labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"), font.label = list(size = 11))

healthyvalues2

#ggsave("healthyvalues.jpeg", plot = healthyvalues, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")

```

### ZK

```{r echo=FALSE}

ZK.Age <- as_tibble(filter(dados_datasetscomp,Sample == "IDOR-ZK")$Age)
colnames(ZK.Age)[1] <- "Age"

paste("Min age = ", min(ZK.Age$Age))
paste("Max age = ", max(ZK.Age$Age))
paste("mean age = ", paste(signif(mean(ZK.Age$Age), 2), "±", signif(sd(ZK.Age$Age), 2)))


# ZK.pred <- ZK.Age %>% mutate(
#   Age = Age,
#   K = a.K * Age + b.K,
#   K.se = sqrt((abs(Age) * a.K.se) ^ 2 + b.K.se ^ 2),
#   S = a.S * Age + b.S,
#   S.se = sqrt((abs(Age) * a.S.se) ^ 2 + b.S.se ^ 2),
#   I = a.I * Age + b.I,
#   I.se = sqrt((abs(Age) * a.I.se) ^ 2 + b.I.se ^ 2),
#   Diagnostic = "CTL-pred",
#   ROI = "hemisphere",
#   Sample = "CTL-pred",
#   Family = "Hominidae",
#   Species = "Homo sapiens"
# )

Age.simulation <- as_tibble(runif(1000, min=2.4375, max=3.125))
colnames(Age.simulation)[1] <- "Age"
# hist(Age.simulation)

ZK.simulation <-
  Age.simulation %>% mutate(
    #Age = rnorm(1000, mean = mean.age, sd = 0.5),
    Age = Age,
    K = rnorm(1000,
              mean = a.K * Age + b.K,
              #sd = sqrt((abs(Age)*a.K.se)^2+b.K.se^2)),
              sd = K.se),
    S = rnorm(1000,
              mean = a.S * Age + b.S,
              #sd = sqrt((abs(Age)*a.S.se)^2+b.S.se^2)),
              sd = S.se),
    # Confirmar sd
    I = rnorm(1000,
              mean = a.I * Age + b.I,
              #sd = sqrt((abs(Age)*a.I.se)^2+b.I.se^2)),
              sd = I.se),
    # Confirmar sd
    Diagnostic = "CTL-simulation",
    ROI = "hemisphere",
    Sample = "CTL-simulation",
  Family = "Hominidae",
  Species = "Homo sapiens"
  )

```

```{r}
amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere", Diagnostic != "MCI" | Diagnostic != "AD") %>%
  group_by(Sample, Diagnostic) %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)

dados_datasetscomp_MH_2 <- filter(dados_datasetscomp_MH, ROI == "hemisphere", Diagnostic != "MCI" | Diagnostic != "AD")

dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Diagnostic == "MICRO"] <- "IDOR-ZKMICRO"


dados_datasetscomp_MH_2$Sample <- as.factor(dados_datasetscomp_MH_2$Sample)

cols = gg_color_hue(length(levels(dados_datasetscomp_MH_2$Sample)))
cols[levels(dados_datasetscomp_MH_2$Sample)=="IDOR-ZKMICRO"]="black"

model_all <- ggplot(data = dados_datasetscomp_MH_2, aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #     nudge_x = 0.3,
  #     label = ifelse(
  #         dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #         dados_datasetscomp_MH_2$Diagnostic,
  #         ""
  #     )
  # ) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

model_all
  
modela <- ggplot(data = dados_datasetscomp_MH_2, aes(I, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #   nudge_x = 0.3,
  #   label = ifelse(
  #     dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #     dados_datasetscomp_MH_2$Diagnostic,
  #     ""
  #   )
  # ) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

modelb <- ggplot(data = dados_datasetscomp_MH_2, aes(K, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #   nudge_x = 0.3,
  #   label = ifelse(
  #     dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #     dados_datasetscomp_MH_2$Diagnostic,
  #     ""
  #   )
  # ) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

model_micro <- ggarrange(modela, modelb, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

model_micro

ggsave("model_micro.jpeg", plot = model_micro, dpi=1200, width = 18, height = 11, units = "cm", device = "jpeg")

amostra_Coef %>% kable(digits = 2) %>% kable_styling()

amostra_Coef <- filter(dados_datasetscomp_MH, ROI == "hemisphere", Diagnostic != "MCI" | Diagnostic != "AD") %>%
  do(fit_amostra = tidy(lm(1/2 * logAvgThickness + logTotalArea ~ logExposedArea, data = ., na.action = na.omit), conf.int = TRUE, conf.level = 0.95)) %>% 
  unnest(fit_amostra)
amostra_Coef %>% kable(digits = 2) %>% kable_styling()
```

```{r}
dados_datasetscomp_MH_2$Family[dados_datasetscomp_MH_2$Sample == "IDOR-ZKMICRO"] <- "Hominidae-ZKMICRO"
dados_datasetscomp_MH_2$Family[dados_datasetscomp_MH_2$Sample == "IDOR-MICRO"] <- "Hominidae-MICRO"

dados_datasetscomp_MH_2$Family <- as.factor(dados_datasetscomp_MH_2$Family)

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(Family, k, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  ) + ylim(0, 0.5)

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(x = Family, y = K/sqrt(1 + (1/4)^2 + (5/4)^2), color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )  + labs(y = "K norm") + ylim(0, -0.45)

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(x = Family, y = 10^(K/sqrt(1 + (1/4)^2 + (5/4)^2)), color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )  + labs(y = "10^K norm") + ylim(0, 0.6)

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(Family, S, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(Family, S/sqrt((3/2)^2 + (3/4)^2 + (9/4)^2), color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9) 
  ) + labs(y = "S norm")

ggplot(filter(dados_datasetscomp_MH_2, ROI == "hemisphere"), aes(Family, I, color = Family, fill = Family, alpha = 0.4)) +
         geom_boxplot()+
         theme_pubr() +
  guides(alpha = FALSE) + 
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1, size=9)
  )

cols = gg_color_hue(length(levels(dados_datasetscomp_MH_2$Family)))
cols[levels(dados_datasetscomp_MH_2$Family)=="Hominidae-ZKMICRO"]="black"
cols[levels(dados_datasetscomp_MH_2$Family)=="Hominidae-MICRO"]="#CC6666"
cols[levels(dados_datasetscomp_MH_2$Family)=="Hominidae"]="gray"

ggplot(data = dados_datasetscomp_MH_2, aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #     nudge_x = 0.3,
  #     label = ifelse(
  #         dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #         dados_datasetscomp_MH_2$Diagnostic,
  #         ""
  #     )
  # ) +
  geom_point(aes(color = Family)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

ggplot(data = dados_datasetscomp_MH_2, aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #     nudge_x = 0.3,
  #     label = ifelse(
  #         dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #         dados_datasetscomp_MH_2$Diagnostic,
  #         ""
  #     )
  # ) +
  geom_point(aes(color = Family)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols) + ylim(4,5.5) + xlim (3.5, 5)

modela2 <- ggplot(data = dados_datasetscomp_MH_2, aes(I, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #   nudge_x = 0.3,
  #   label = ifelse(
  #     dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #     dados_datasetscomp_MH_2$Diagnostic,
  #     ""
  #   )
  # ) +
  geom_point(aes(color = Family)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

modelb2 <- ggplot(data = dados_datasetscomp_MH_2, aes(K, S)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #   nudge_x = 0.3,
  #   label = ifelse(
  #     dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #     dados_datasetscomp_MH_2$Diagnostic,
  #     ""
  #   )
  # ) +
  geom_point(aes(color = Family)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols)

ggarrange(modela2, modelb2, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

dados_datasetscomp_MH_2$Family[dados_datasetscomp_MH_2$Sample == "IDOR-ZKMICRO" | dados_datasetscomp_MH_2$Sample == "IDOR-MICRO"] <- "Hominidae"

dados_datasetscomp_MH_2$Species[dados_datasetscomp_MH_2$Sample == "IDOR-ZKMICRO"] <- "Homo sapiens ZKMICRO"
dados_datasetscomp_MH_2$Species[dados_datasetscomp_MH_2$Sample == "IDOR-MICRO"] <- "Homo sapiens MICRO"


dados_datasetscomp_MH_2_zoom <- filter(dados_datasetscomp_MH_2,
                                       S < 11 &
                                         S > 8.5 &
                                         Species != "Homo sapiens" & I > 8)

dados_datasetscomp_MH_2_zoom$Species <- as.factor(dados_datasetscomp_MH_2_zoom$Species)

# cols = gg_color_hue(length(levels(dados_datasetscomp_MH_2_zoom$Species)))
# cols[levels(dados_datasetscomp_MH_2_zoom$Species)=="Homo sapiens MICRO"]="black"

modela2zoom <-
  ggplot(
    data = dados_datasetscomp_MH_2_zoom,
    aes(I, S)
  ) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #   nudge_x = 0.3,
  #   label = ifelse(
  #     dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #     dados_datasetscomp_MH_2$Diagnostic,
  #     ""
  #   )
  # ) +
  geom_point(aes(shape = Family, color = Species)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    legend.box = "vertical",
    legend.box.just = "top"
  ) + guides(shape = guide_legend(order = 1),
             color = guide_legend(order = 2))
#+ scale_color_manual(values = cols)
  
modelb2zoom <-
  ggplot(
    data = dados_datasetscomp_MH_2_zoom,
    aes(K, S)
  ) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(nudge_x = 0.3,
  #           label =S) +
  geom_point(aes(shape = Family, color = Species)) +
  theme_pubr() +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10),
    legend.box = "vertical",
    legend.box.just = "top"
  ) + guides(shape = guide_legend(order = 1),
             color = guide_legend(order = 2))
#+ scale_color_manual(values = cols)

modelzoom <- ggarrange(modela2zoom, modelb2zoom, labels = c("A","B"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

modelzoom

ggsave("modelzoom.jpeg", plot = modelzoom, dpi=1200, width = 16, height = 11, units = "cm", device = "jpeg")

filter(dados_datasetscomp_MH_2,
       S < 11 & S > 8.5 & Species != "Homo sapiens" & I > 8) %>% dplyr::select(c(Family, Species, K, S, I)) %>% kable(digits = 2) %>% kable_styling()

```


```{r}
dados_datasetscomp_MH_2 <- dados_datasetscomp_MH_2 %>% full_join(ZK.simulation)
#%>% full_join(ZK.pred) 

dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp_MH_2$Diagnostic == "ZK"] <- "IDOR-ZK"
dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp_MH_2$Diagnostic == "CHIK"] <- "IDOR-CHIK"
dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp_MH_2$Diagnostic == "MICRO"] <- "IDOR-ZKMICRO"
dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp_MH_2$Diagnostic == "PRES ZK"] <- "IDOR-PRESZK"
dados_datasetscomp_MH_2$Sample[dados_datasetscomp_MH_2$Sample == "IDOR-ZK" &
                                  dados_datasetscomp_MH_2$Diagnostic == "OUTROS"] <- "IDOR-OUTROS"

dados_datasetscomp_2 <- dados_datasetscomp_MH_2 %>% filter(Sample != "Mota&Houzel2015")

simu_allsamplesa <- ggplot(dados_datasetscomp_2,
       aes(x = Age, y = K, alpha = 0.4, color = Sample)) +
  geom_point() +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10))

simu_allsamplesb <- ggplot(dados_datasetscomp_2,
       aes(x = Age, y = S, alpha = 0.4, color = Sample)) +
  geom_point() +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none")

simu_allsamplesc <- ggplot(dados_datasetscomp_2,
       aes(x = Age, y = I, alpha = 0.4, color = Sample)) +
  geom_point() +
  #geom_smooth(color = "black", linetype = 2) +
  geom_smooth(color = "black", method = "lm") +
  theme_pubr() +
  guides(alpha = FALSE)+ 
  labs(x = "Age [years]") +
  theme(axis.title = element_text(size = 11),
    axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none")

simu_allsamples <- ggarrange(simu_allsamplesa, ggarrange(simu_allsamplesb, simu_allsamplesc,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

simu_allsamples

ggsave("simu_allsamples.jpeg", plot = simu_allsamples, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")

write.csv(dados_datasetscomp_MH_2, "dados_datasetscomp_MH_2.csv")

```

```{r}
dados_zk2 <- dados_zk
dados_zk2$Sample[dados_zk2$Diagnostic == "MICRO"] <- "IDOR-ZKMICRO"
dados_zk2$Sample <- as.factor(dados_zk2$Sample)  

cols2 = gg_color_hue(length(levels(dados_zk2$Sample)))
cols2[levels(dados_zk2$Sample)=="IDOR-ZKMICRO"]="black"

model_all_zk <- ggplot(data = filter(dados_zk2, ROI == "hemisphere"), aes(logExposedArea, 1 / 2 * logAvgThickness + logTotalArea)) +
  geom_smooth(method = "lm", se = FALSE) +
  # geom_text(
  #     nudge_x = 0.3,
  #     label = ifelse(
  #         dados_datasetscomp_MH_2$Diagnostic == "MICRO",
  #         dados_datasetscomp_MH_2$Diagnostic,
  #         ""
  #     )
  # ) +
  geom_point(aes(color = Sample)) +
  theme_pubr() + guides(shape = FALSE) +
  theme(
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    text = element_text(size = 10)
  ) +
  scale_color_manual(values = cols2)

model_all_zk

model_all_fig <- ggarrange(model_all, model_all_zk,labels = c("A", "B"), nrow = 1, ncol = 2, font.label = list(size = 11), common.legend = TRUE, legend = "top")

model_all_fig

ggsave("model_all_fig.jpeg", plot = model_all_fig, dpi=1200, width = 18, height = 11, units = "cm", device = "jpeg")
```


```{r echo=FALSE}
ZK <- filter(dados_zk, ROI == "hemisphere") %>% dplyr::select(c(Age, K, S, I, Diagnostic))

#ZK.pred <- ZK.pred %>% dplyr::select(c(Age, K, S, I, Diagnostic))
ZK.simulation <- ZK.simulation %>% dplyr::select(c(Age, K, S, I, Diagnostic))

#ZK <- full_join(ZK, ZK.pred)

# ggplot(ZK, aes(Age, K, color = Diagnostic, fill = Diagnostic)) +
#   geom_point() +
#   geom_smooth(method = "lm") +
#   stat_cor() +
#   theme_pubr() +
#   labs(y = "K", x = "Age [years]")  +
#     theme(axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

ZK <- full_join(ZK, ZK.simulation)

zk_k <- ggplot(ZK, aes(Age, K, color = Diagnostic, fill = Diagnostic)) +
  geom_point() +
  geom_smooth(method = "lm") +
  #stat_cor() +
  theme_pubr() +
  labs(y = "K", x = "Age [years]")  +
    theme(axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

zk_s <- ggplot(ZK, aes(Age, S, color = Diagnostic, fill = Diagnostic)) +
  geom_point() +
  geom_smooth(method = "lm") +
  #stat_cor() +
  theme_pubr() +
  labs(y = "S", x = "Age [years]")  +
    theme(axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none")

zk_i <- ggplot(ZK, aes(Age, I, color = Diagnostic, fill = Diagnostic)) +
  geom_point() +
  geom_smooth(method = "lm") +
  #stat_cor() +
  theme_pubr() +
  labs(y = "I", x = "Age [years]")  +
    theme(axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10), legend.position = "none")

zk <- ggarrange(zk_k, ggarrange(zk_s, zk_i,labels = c("B","C"), nrow = 1, ncol = 2, font.label = list(size = 11)),labels = c("A"), nrow = 2, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

zk

ggsave("zk.jpeg", plot = zk, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")

# cor.test(filter(ZK, Diagnostic == "CTL")$K, filter(ZK, Diagnostic == "CTL")$Age)

ZK_boxplot_k <- ggplot(ZK, aes(Diagnostic, K)) +
  geom_boxplot() +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

ZK_boxplot_s <- ggplot(ZK, aes(Diagnostic, S)) +
  geom_boxplot() +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

ZK_boxplot_i <- ggplot(ZK, aes(Diagnostic, I)) +
  geom_boxplot() +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

ZK_boxplot <- ggarrange(ZK_boxplot_k, ggarrange(ZK_boxplot_s, ZK_boxplot_i,labels = c("B","C"), nrow = 2, ncol = 1, font.label = list(size = 11)),labels = c("A"), nrow = 1, ncol = 2, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ZK_boxplot

ggsave("ZK_boxplot.jpeg", plot = ZK_boxplot, dpi=1200, width = 18, height = 12, units = "cm", device = "jpeg")

# ggplot(ZK, aes(K, color = Diagnostic, fill = Diagnostic, alpha=0.4)) + geom_density()+theme_pubr() +  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=9), axis.title = element_text(size = 11),  axis.text = element_text(size = 10), text = element_text(size = 10))

a <- aov(K ~ Diagnostic, data = ZK)
summary(a)
a.TukeyHSD <- as.data.frame(TukeyHSD(a)$`Diagnostic`)
Contrasts <- as.data.frame(rownames(TukeyHSD(a)$`Diagnostic`))
a.TukeyHSD <- as_tibble(cbind(Contrasts, a.TukeyHSD))
rownames(a.TukeyHSD) <- NULL
colnames(a.TukeyHSD)[1] <- c("Contrast")
a.TukeyHSD <- a.TukeyHSD %>%
  mutate(Diagnostic.1 = str_split(a.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,1], Diagnostic.2 = str_split(a.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,2])
# a.TukeyHSD <- a.TukeyHSD%>%
#   mutate(Diagnostic.1 = str_split(a.TukeyHSD$Contrast1, pattern = ":", simplify = TRUE)[,1], Diagnostic.2 = str_split(a.TukeyHSD$Contrast2, pattern = ":", simplify = TRUE)[,1], ROI.1 = str_split(a.TukeyHSD$Contrast1, pattern = ":", simplify = TRUE)[,2], ROI.2 = str_split(a.TukeyHSD$Contrast2, pattern = ":", simplify = TRUE)[,2]) %>% filter(ROI.1 == ROI.2) %>% dplyr::select(-c(Contrast1 , Contrast2))

# a.TukeyHSD$ROI.1 <- as.factor(a.TukeyHSD$ROI.1)
# a.TukeyHSD$ROI.1 <- relevel(a.TukeyHSD$ROI.1, ref = "hemisphere")


# a.TukeyHSD.graph <- filter(a.TukeyHSD, ROI.1 == ROI.2) %>% mutate(Contrast = str_c(Diagnostic.2, Diagnostic.1, sep = "-"))

ZK_tukey_k <- ggplot(data = filter(a.TukeyHSD, `p adj` < 0.05 | `p adj` == 0.05), aes(x = Contrast,
    y = diff,
    ymin = lwr,
    ymax = upr)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange() + geom_text(aes(label = str_c("p adj = ", signif(`p adj`, digits = 2))),   nudge_x = 0.38) +
    coord_flip() +
    labs(title = "95% family-wise confidence level", y =  "Diff in K mean levels of Diagnostic", x = "Contrast") +
    theme_pubr() 
#+   facet_wrap(Contrast ~ .)

b <- aov(S ~ Diagnostic, data = ZK)
summary(b)
b.TukeyHSD <- as.data.frame(TukeyHSD(b)$`Diagnostic`)
Contrasts <- as.data.frame(rownames(TukeyHSD(b)$`Diagnostic`))
b.TukeyHSD <- as_tibble(cbind(Contrasts, b.TukeyHSD))
rownames(b.TukeyHSD) <- NULL
colnames(b.TukeyHSD)[1] <- c("Contrast")
b.TukeyHSD <- b.TukeyHSD %>%
  mutate(Diagnostic.1 = str_split(b.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,1], Diagnostic.2 = str_split(b.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,2])

ZK_tukey_s <- ggplot(data = filter(b.TukeyHSD, `p adj` < 0.05 | `p adj` == 0.05), aes(x = Contrast,
    y = diff,
    ymin = lwr,
    ymax = upr)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange() + geom_text(aes(label = str_c("p adj = ", signif(`p adj`, digits = 2))),   nudge_x = 0.38) +
    coord_flip() +
    labs(title = "95% family-wise confidence level", y =  "Diff in S mean levels of Diagnostic", x = "Contrast") +
    theme_pubr() 
#+   facet_wrap(Contrast ~ .)

c <- aov(I ~ Diagnostic, data = ZK)
summary(c)
c.TukeyHSD <- as.data.frame(TukeyHSD(c)$`Diagnostic`)
Contrasts <- as.data.frame(rownames(TukeyHSD(c)$`Diagnostic`))
c.TukeyHSD <- as_tibble(cbind(Contrasts, c.TukeyHSD))
rownames(c.TukeyHSD) <- NULL
colnames(c.TukeyHSD)[1] <- c("Contrast")
c.TukeyHSD <- c.TukeyHSD %>%
  mutate(Diagnostic.1 = str_split(c.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,1], Diagnostic.2 = str_split(c.TukeyHSD$Contrast, pattern = "-", simplify = TRUE)[,2])

ZK_tukey_i <- ggplot(data = filter(c.TukeyHSD, `p adj` < 0.05 | `p adj` == 0.05), aes(x = Contrast,
    y = diff,
    ymin = lwr,
    ymax = upr)) +
    geom_hline(yintercept = 0,
               linetype = "11",
               colour = "grey60") +
    geom_pointrange() + geom_text(aes(label = str_c("p adj = ", signif(`p adj`, digits = 2))),   nudge_x = 0.38) +
    coord_flip() +
    labs(title = "95% family-wise confidence level", y =  "Diff in I mean levels of Diagnostic", x = "Contrast") +
    theme_pubr() 
#+   facet_wrap(Contrast ~ .)

ZK_tukey <- ggarrange(ZK_tukey_k, ZK_tukey_s, ZK_tukey_i,labels = c("A","B","C"), nrow = 3, ncol = 1, font.label = list(size = 11), common.legend = TRUE, legend = "top")

ZK_tukey

ggsave("ZK_tukey.jpeg", plot = ZK_tukey, dpi=1200, width = 18, height = 22, units = "cm", device = "jpeg")
```
